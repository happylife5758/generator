<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAPPYLIFE AI GENERATOR</title>
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
       <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
	
	
	<style>
/* --- Elegant Purple Theme with Solid Background --- */
    
:root {
    --bg-dark: #154b44;
    --bg-panel: #007768;
    --border-gradient: linear-gradient(135deg, #8de6dc, #33dbea, #74f4ff);
    --text-primary: #f8f7f2;
    --text-accent: #facc15;
    --accent-teal: #14b8a6;
}

body {
    font-family: 'Inter', sans-serif;
    background: var(--bg-dark) url('BG.png') no-repeat center center;
    background-size: cover;
    background-attachment: scroll; /* aman untuk mobile */
    color: var(--text-primary);
    line-height: 1.6;
}

/* --- Header Flex Container --- */
.header-content {
    display: flex;
    align-items: center;
    gap: 1rem; /* jarak logo dengan teks */
    flex-wrap: wrap; /* wrap otomatis di mobile */
}

/* Logo */
.header-content img {
    flex-shrink: 0; /* logo tidak mengecil */
}

/* Judul responsif */
.header-content h1 {
    font-size: clamp(1.5rem, 4vw, 2.5rem);
    font-weight: bold;
    color: var(--text-primary);
    margin: 0;
    white-space: nowrap;        /* selalu satu baris */
    overflow: hidden;
    text-overflow: ellipsis;    /* kalau kepanjangan jadi ... */
}s

/* Deskripsi responsif */
.header-content p {
    font-size: clamp(0.875rem, 2.5vw, 1.125rem);
    color: #d1d5db; /* gray-300 */
    margin: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Mobile tweak */
@media (max-width: 640px) {
    .header-content h1,
    .header-content p {
        white-space: normal; /* wrap di mobile */
    }
}

/* --- Loader with Gradient --- */
.loader {
    border: 4px solid transparent;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    background: var(--border-gradient);
    -webkit-mask: 
        radial-gradient(farthest-side, #000 92%, #0000) content-box,
        radial-gradient(farthest-side, #000 92%, #0000);
    -webkit-mask-composite: xor;
    mask-composite: exclude;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* --- Modal Animations --- */
.modal-enter { animation: fadeIn 0.3s ease-out; }
.modal-leave { animation: fadeOut 0.3s ease-in; }

@keyframes fadeIn { 
    from { opacity: 0; transform: scale(0.95); } 
    to { opacity: 1; transform: scale(1); } 
}
@keyframes fadeOut { 
    from { opacity: 1; transform: scale(1); } 
    to { opacity: 0; transform: scale(0.95); } 
}

/* --- Image Preview with Gradient Border --- */
.image-preview {
    width: 128px;
    height: 128px;
    border: 2px solid transparent;
    border-radius: 0.5rem;
    background: var(--bg-panel) padding-box, var(--border-gradient) border-box;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-accent);
    font-size: 0.875rem;
    background-size: cover;
    background-position: center;
}

/* --- Buttons and Panel Highlights --- */
button, .panel {
    background: var(--bg-panel);
    color: var(--text-primary);
    border-radius: 0.5rem;
    border: none;
    padding: 0.5rem 1rem;
    transition: all 0.2s ease-in-out;
}

button:hover, .panel:hover {
    background: #4b1d8f;
    color: var(--text-accent);
    cursor: pointer;
}

/* --- Iklan & Review Generator Specific Styles --- */
.creative-option input:checked + label {
    background-color: var(--accent-teal);
    color: white;
    border-color: var(--accent-teal);
    box-shadow: 0 0 15px rgba(20, 184, 166, 0.5);
}
.creative-option label {
    transition: all 0.2s ease-in-out;
}

.asset-upload-box {
    aspect-ratio: 1 / 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    border: 2px dashed #6b7280;
    border-radius: 0.75rem;
    cursor: pointer;
    transition: all 0.2s ease-in-out;
    position: relative;
    overflow: hidden;
}
.asset-upload-box:hover {
    border-color: var(--accent-teal);
    background-color: rgba(20, 184, 166, 0.1);
}
.asset-upload-box img.preview {
    width: 100%;
    height: 100%;
    object-fit: cover;
    position: absolute;
    top: 0;
    left: 0;
}
.remove-asset-btn {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    background-color: rgba(0,0,0,0.6);
    border-radius: 9999px;
    width: 1.75rem;
    height: 1.75rem;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    opacity: 0;
    transition: opacity 0.2s ease-in-out;
}
.asset-upload-box:hover .remove-asset-btn {
    opacity: 1;
}

/* --- Responsive Background --- */
@media (max-width: 640px) {
    .header-content h1 {
        white-space: normal;
        overflow: visible;
        text-overflow: unset;
    }
}
@media (min-width: 769px) {
    body {
        background-attachment: fixed;
    }
}

/* --- Typography --- */
h1, h2, h3, p, span, label {
    color: var(--text-primary);
}

/* Header Gradient Border */
.header-gradient-border {
    border: 4px solid transparent;
    border-radius: 1rem;
    background: linear-gradient(var(--bg-panel), var(--bg-panel)) padding-box,
                var(--border-gradient) border-box;
    display: inline-block;
    padding: 1rem 2rem;
    box-shadow: 0 4px 15px rgba(124, 58, 237, 0.4);
}

/* --- Footer --- */
.site-footer {
    text-align: center;
    padding: 1rem 0;
    background-color: var(--bg-panel);
    color: var(--text-primary);
    font-size: 0.875rem;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
}

.site-footer .credit-name {
    color: var(--text-accent);
    font-weight: 500;
}
</style>

 </head>
<body class="text-[var(--text-primary)]">

    <!-- Password Modal -->
    <div id="password-modal" class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
        <div class="w-full max-w-sm">
            <form id="password-form" class="bg-[var(--bg-panel)] p-8 rounded-2xl shadow-2xl border border-[var(--border-color)]">
                <h2 class="text-2xl font-bold text-white text-center mb-4">Akses Diperlukan</h2>
                <p class="text-center text-[var(--text-secondary)] mb-6 text-sm">Silakan masukkan password untuk melanjutkan.</p>
                <div class="mb-4">
                    <label for="password-input" class="sr-only">Password</label>
                    <input type="password" id="password-input" class="w-full px-4 py-3 bg-[var(--bg-dark)] border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--accent-lime)] text-white transition" placeholder="Password" required>
                </div>
                <p id="password-error" class="text-red-400 text-center text-sm mb-4 hidden">Password salah. Coba lagi.</p>
                <button type="submit" class="w-full bg-[var(--accent-lime)] text-black font-bold py-3 px-4 rounded-lg hover:bg-[var(--accent-lime-hover)] transition-colors">Masuk</button>
            </form>
        </div>
    </div>


    <div id="app-container" class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-4xl hidden">
        
        <header class="text-center mb-8">
  <div class="bg-[var(--bg-panel)] p-4 sm:p-6 rounded-xl shadow-lg mb-8 border border-[var(--border-color)]">
    <div class="flex items-center gap-4">
      
      <!-- Logo di kiri -->
      <div class="header-gradient-border">
        <img src="BG2.png" 
             alt="Logo" 
             class="w-16 h-16 object-contain">
      </div>

      <!-- Judul + deskripsi -->
      <div class="text-left">
        <h1 class="text-3xl sm:text-4xl font-bold text-white">HAPPYLIFE AI GENERATOR</h1>
        <p class="text-sm sm:text-base text-gray-300">Generate Video AI Cepat</p>
      </div>

    </div>
  </div>
</header>

        <!-- Main Tabs -->
        <div class="bg-[var(--bg-panel)] p-4 sm:p-6 rounded-xl shadow-lg mb-8 border border-[var(--border-color)]">
            <nav class="flex space-x-1 sm:space-x-4 overflow-x-auto pb-2" aria-label="Tabs">
                <button id="main-tab-text-to-video" class="flex-shrink-0 px-3 sm:px-4 py-2 font-medium text-sm rounded-t-lg text-white border-b-2 border-[var(--accent-lime)]">Text to Video</button>
                <button id="main-tab-image-to-video" class="flex-shrink-0 px-3 sm:px-4 py-2 font-medium text-sm rounded-t-lg text-[var(--text-secondary)] hover:text-white">Image to Video</button>
                <button id="main-tab-iklan-generator" class="flex-shrink-0 px-3 sm:px-4 py-2 font-medium text-sm rounded-t-lg text-[var(--text-secondary)] hover:text-white">Iklan Generator</button>
                <button id="main-tab-review-produk" class="flex-shrink-0 px-3 sm:px-4 py-2 font-medium text-sm rounded-t-lg text-[var(--text-secondary)] hover:text-white">Review Produk</button>
                <button id="main-tab-text-to-image" class="flex-shrink-0 px-3 sm:px-4 py-2 font-medium text-sm rounded-t-lg text-[var(--text-secondary)] hover:text-white">Text to Image</button>
                <button id="main-tab-json-prompt" class="flex-shrink-0 px-3 sm:px-4 py-2 font-medium text-sm rounded-t-lg text-[var(--text-secondary)] hover:text-white">JSON Prompt</button>
                <button id="main-tab-image-to-image" class="flex-shrink-0 px-3 sm:px-4 py-2 font-medium text-sm rounded-t-lg text-[var(--text-secondary)] hover:text-white">Image to Image</button>
            </nav>
        </div>

        <div class="bg-[var(--bg-panel)] p-4 sm:p-6 rounded-xl shadow-lg mb-8 border border-[var(--border-color)]">
            <!-- Shared Settings -->
            <div class="mb-4">
                <div class="flex justify-between items-center mb-2">
                    <label for="api-keys" class="block text-sm font-medium text-[var(--text-primary)]">Google AI API Keys</label>
                
                </div>
                <textarea id="api-keys" name="api-keys" rows="3" class="w-full px-3 py-2 bg-[var(--bg-dark)] border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--accent-lime)] text-white transition" placeholder="Masukkan satu atau lebih API Key di sini"></textarea>
            </div>
            
            <details class="bg-black/20 p-4 rounded-lg mb-4">
                <summary class="cursor-pointer text-white font-semibold">Pengaturan Lanjutan</summary>
                <div class="mt-4 space-y-4">
                    <div>
                        <label for="negative-prompt" class="block text-sm font-medium text-[var(--text-primary)] mb-2">Negative Prompt</label>
                        <input type="text" id="negative-prompt" class="w-full px-3 py-2 bg-[var(--bg-dark)] border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--accent-lime)] text-white" placeholder="Contoh: blurry, low quality, text">
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                             <label for="multiple-generate-select" class="block text-sm font-medium text-[var(--text-primary)] mb-2">Multiple Generate</label>
                             <select id="multiple-generate-select" class="w-full px-3 py-2 bg-[var(--bg-dark)] border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--accent-lime)] text-white">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                             </select>
                        </div>
                        <div>
                             <label for="delay-select" class="block text-sm font-medium text-[var(--text-primary)] mb-2">Jeda Antar Batch (detik)</label>
                             <select id="delay-select" class="w-full px-3 py-2 bg-[var(--bg-dark)] border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--accent-lime)] text-white">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                                <option value="10">10</option>
                             </select>
                        </div>
                    </div>
                </div>
            </details>
            <hr class="border-[var(--border-color)] my-6">

            <!-- Text to Video Panel -->
            <div id="panel-text-to-video">
                <form id="prompt-form">
                     <div class="mb-4">
                        <label for="model-select-video-text" class="block text-sm font-medium text-[var(--text-primary)] mb-2">Pilih Model Video</label>
                        <select id="model-select-video-text" class="w-full px-3 py-2 bg-[var(--bg-dark)] border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--accent-lime)] text-white">
                            <option value="veo-3.0-generate-preview">Veo 3</option>
                            <option value="veo-3.0-fast-generate-preview">Veo 3 (Cepat)</option>
                            <option value="veo-2.0-generate-001">Veo 2</option>
                        </select>
                    </div>
                    <div id="veo2-settings-container-text" class="space-y-4 mb-4 hidden">
                        <div>
                            <label for="duration-select-text" class="block text-sm font-medium text-[var(--text-primary)] mb-2">Durasi Video (untuk Veo 2)</label>
                            <select id="duration-select-text" class="w-full px-3 py-2 bg-[var(--bg-dark)] border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--accent-lime)] text-white">
                                <option value="5">5 detik</option>
                                <option value="6">6 detik</option>
                                <option value="7">7 detik</option>
                                <option value="8">8 detik</option>
                            </select>
                        </div>
                        <div>
                           <label for="aspect-ratio-select-veo2-text" class="block text-sm font-medium text-[var(--text-primary)] mb-2">Aspek Rasio (untuk Veo 2)</label>
                            <select id="aspect-ratio-select-veo2-text" class="w-full px-3 py-2 bg-[var(--bg-dark)] border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--accent-lime)] text-white">
                                <option value="16:9">16:9 (Landscape)</option>
                                <option value="9:16">9:16 (Portrait)</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-2">
                             <label for="prompts" class="block text-sm font-medium text-[var(--text-primary)]">Prompts (satu per baris)</label>
                             <button type="button" id="open-gemini-modal-btn" class="text-sm text-[var(--accent-lime)] font-semibold hover:text-[var(--accent-lime-hover)] transition">✨ Asisten Prompt AI</button>
                        </div>
                        <textarea id="prompts" name="prompts" rows="8" class="w-full px-3 py-2 bg-[var(--bg-dark)] border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--accent-lime)] text-white transition" placeholder="Salin-tempel beberapa baris dari editor teks atau spreadsheet." required></textarea>
                        <p class="text-xs text-[var(--text-secondary)] mt-1 text-right">Jumlah Prompt: <span id="prompt-count-text">0</span></p>
                    </div>
                    <div>
                        <button type="submit" id="generate-btn-text" class="w-full bg-[var(--accent-lime)] text-black font-bold py-3 px-4 rounded-lg hover:bg-[var(--accent-lime-hover)] focus:outline-none focus:ring-4 focus:ring-lime-500/50 transition-all duration-300 ease-in-out flex items-center justify-center disabled:bg-gray-600">
                            <span class="btn-text">Generate Video dari Teks</span>
                        </button>
                    </div>
                </form>
            </div>
            <!-- Image to Video Panel -->
            <div id="panel-image-to-video" class="hidden">
                 <form id="image-form">
                    <div class="mb-4">
                        <label for="model-select-video-image" class="block text-sm font-medium text-[var(--text-primary)] mb-2">Pilih Model Video</label>
                        <select id="model-select-video-image" class="w-full px-3 py-2 bg-[var(--bg-dark)] border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--accent-lime)] text-white">
                            <option value="veo-3.0-generate-preview">Veo 3</option>
                            <option value="veo-3.0-fast-generate-preview">Veo 3 (Cepat)</option>
                            <option value="veo-2.0-generate-001">Veo 2</option>
                        </select>
                    </div>
                    <div id="veo2-settings-container-image" class="space-y-4 mb-4 hidden">
                        <div>
                            <label for="duration-select-image" class="block text-sm font-medium text-[var(--text-primary)] mb-2">Durasi Video (untuk Veo 2)</label>
                            <select id="duration-select-image" class="w-full px-3 py-2 bg-[var(--bg-dark)] border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--accent-lime)] text-white">
                                <option value="5">5 detik</option>
                                <option value="6">6 detik</option>
                                <option value="7">7 detik</option>
                                <option value="8">8 detik</option>
                            </select>
                        </div>
                        <div>
                           <label for="aspect-ratio-select-veo2-image" class="block text-sm font-medium text-[var(--text-primary)] mb-2">Aspek Rasio (untuk Veo 2)</label>
                            <select id="aspect-ratio-select-veo2-image" class="w-full px-3 py-2 bg-[var(--bg-dark)] border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--accent-lime)] text-white">
                                <option value="16:9">16:9 (Landscape)</option>
                                <option value="9:16">9:16 (Portrait)</option>
                            </select>
                        </div>
                    </div>
                    <details class="bg-black/20 p-4 rounded-lg mb-4">
                        <summary class="cursor-pointer text-white font-semibold">Arah Kreatif (Opsional)</summary>
                        <div class="mt-4 grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <div>
                                <label for="creative-vibe" class="block text-sm font-medium text-[var(--text-primary)] mb-2">Vibe</label>
                                <select id="creative-vibe" class="w-full px-3 py-2 bg-[var(--bg-dark)] border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--accent-lime)] text-white">
                                    <option value="Modern & Minimalist">Modern & Minimalis</option>
                                    <option value="Elegant & Luxurious">Elegan & Mewah</option>
                                    <option value="Energetic & Sporty">Enerjik & Sporty</option>
                                    <option value="Natural & Organic">Alami & Organik</option>
                                    <option value="Futuristic & High-Tech">Futuristik & Canggih</option>
                                </select>
                            </div>
                            <div>
                                <label for="creative-lighting" class="block text-sm font-medium text-[var(--text-primary)] mb-2">Pencahayaan</label>
                                <select id="creative-lighting" class="w-full px-3 py-2 bg-[var(--bg-dark)] border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--accent-lime)] text-white">
                                    <option value="Bright studio lighting">Cahaya Studio Terang</option>
                                    <option value="Soft, golden hour light">Golden Hour Lembut</option>
                                    <option value="Neon & Cyberpunk glow">Neon & Cyberpunk</option>
                                    <option value="Dramatic & cinematic shadows">Dramatis & Sinematik</option>
                                    <option value="Natural daylight">Cahaya Alami Siang Hari</option>
                                </select>
                            </div>
                            <div>
                                <label for="creative-content-type" class="block text-sm font-medium text-[var(--text-primary)] mb-2">Tipe Konten</label>
                                <select id="creative-content-type" class="w-full px-3 py-2 bg-[var(--bg-dark)] border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--accent-lime)] text-white">
                                    <option value="Focused product shot">Iklan Produk Fokus</option>
                                    <option value="Cinematic lifestyle video">Video Lifestyle Sinematik</option>
                                    <option value="Creative stop motion">Stop Motion Kreatif</option>
                                    <option value="Looping animation">Animasi Looping</option>
                                    <option value="Slow-motion showcase">Pameran Slow-Motion</option>
                                </select>
                            </div>
                        </div>
                    </details>
                    <div class="flex justify-between items-center mb-4">
                        <label class="block text-sm font-medium text-[var(--text-primary)]">Daftar Gambar & Prompt</label>
                        <button type="button" id="generate-all-prompts-btn" class="text-sm text-[var(--accent-lime)] font-semibold hover:text-[var(--accent-lime-hover)] transition">✨ Hasilkan Semua Prompt</button>
                    </div>
                    <div id="image-uploads-container">
                        <!-- Image upload blocks will be injected here -->
                    </div>
                    <label for="batch-image-upload" class="mt-4 w-full text-[var(--accent-lime)] border border-dashed border-[var(--accent-lime)] rounded-lg py-2 text-center block cursor-pointer hover:bg-lime-400/10 transition">Pilih Gambar Batch</label>
                    <input type="file" id="batch-image-upload" class="hidden" multiple accept="image/*">
                    <div class="mt-6">
                        <button type="submit" id="generate-btn-image" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-500/50 transition-all duration-300 ease-in-out flex items-center justify-center disabled:bg-gray-600">
                             <span class="btn-text">Generate Video dari Gambar</span>
                        </button>
                    </div>
                 </form>
            </div>
            <!-- Iklan Generator Panel -->
            <div id="panel-iklan-generator" class="hidden">
                <form id="iklan-generator-form" class="space-y-8">
                    <div>
                        <h3 class="text-lg font-semibold text-white mb-2">1. Unggah Produk</h3>
                        <label for="iklan-batch-upload" class="w-full text-gray-300 border-2 border-dashed border-gray-500 rounded-xl p-8 text-center block cursor-pointer hover:bg-white/5 hover:border-white transition">
                             <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                             <span class="mt-4 font-bold block">Klik untuk unggah</span>
                             <span class="mt-1 text-xs block text-gray-400">Anda bisa memilih satu atau lebih gambar</span>
                        </label>
                        <input type="file" id="iklan-batch-upload" class="hidden" multiple accept="image/*">
                        <div id="iklan-preview-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 mt-6"></div>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-white mb-2">2. Deskripsi Produk</h3>
                        <textarea id="iklan-deskripsi" rows="3" class="w-full px-3 py-2 bg-[var(--bg-dark)] border border-gray-600 rounded-lg focus:ring-2 focus:ring-[var(--accent-teal)] text-white transition" placeholder="Contoh: Kemeja flanel lengan panjang, bahan katun premium, cocok untuk gaya kasual."></textarea>
                    </div>
                    <div>
                         <h3 class="text-lg font-semibold text-white mb-4">3. Arah Kreatif</h3>
                         <div class="space-y-6">
                            <div>
                                <h4 class="font-semibold text-gray-200 mb-3">Vibe</h4>
                                <div class="flex flex-wrap gap-3">
                                    <div class="creative-option"><input type="radio" name="iklan_vibe" id="vibe_energetic" value="Energetic & Fun" class="sr-only" checked><label for="vibe_energetic" class="block cursor-pointer border-2 border-gray-600 rounded-full px-4 py-2 text-sm hover:border-[var(--accent-teal)]">⚡ Energetic & Fun</label></div>
                                    <div class="creative-option"><input type="radio" name="iklan_vibe" id="vibe_cinematic" value="Cinematic & Epic" class="sr-only"><label for="vibe_cinematic" class="block cursor-pointer border-2 border-gray-600 rounded-full px-4 py-2 text-sm hover:border-[var(--accent-teal)]">🎬 Cinematic & Epic</label></div>
                                    <div class="creative-option"><input type="radio" name="iklan_vibe" id="vibe_modern" value="Modern & Clean" class="sr-only"><label for="vibe_modern" class="block cursor-pointer border-2 border-gray-600 rounded-full px-4 py-2 text-sm hover:border-[var(--accent-teal)]">✨ Modern & Clean</label></div>
                                    <div class="creative-option"><input type="radio" name="iklan_vibe" id="vibe_natural" value="Natural & Organic" class="sr-only"><label for="vibe_natural" class="block cursor-pointer border-2 border-gray-600 rounded-full px-4 py-2 text-sm hover:border-[var(--accent-teal)]">🌿 Natural & Organic</label></div>
                                    <div class="creative-option"><input type="radio" name="iklan_vibe" id="vibe_tech" value="Tech & Futuristic" class="sr-only"><label for="vibe_tech" class="block cursor-pointer border-2 border-gray-600 rounded-full px-4 py-2 text-sm hover:border-[var(--accent-teal)]">🤖 Tech & Futuristic</label></div>
                                </div>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-200 mb-3">Pencahayaan</h4>
                                <div class="flex flex-wrap gap-3">
                                    <div class="creative-option"><input type="radio" name="iklan_lighting" id="light_studio" value="Studio Light" class="sr-only" checked><label for="light_studio" class="block cursor-pointer border-2 border-gray-600 rounded-full px-4 py-2 text-sm hover:border-[var(--accent-teal)]">💡 Studio Light</label></div>
                                    <div class="creative-option"><input type="radio" name="iklan_lighting" id="light_dramatic" value="Dramatic" class="sr-only"><label for="light_dramatic" class="block cursor-pointer border-2 border-gray-600 rounded-full px-4 py-2 text-sm hover:border-[var(--accent-teal)]">🎭 Dramatic</label></div>
                                    <div class="creative-option"><input type="radio" name="iklan_lighting" id="light_natural" value="Natural Light" class="sr-only"><label for="light_natural" class="block cursor-pointer border-2 border-gray-600 rounded-full px-4 py-2 text-sm hover:border-[var(--accent-teal)]">☀️ Natural Light</label></div>
                                    <div class="creative-option"><input type="radio" name="iklan_lighting" id="light_neon" value="Neon" class="sr-only"><label for="light_neon" class="block cursor-pointer border-2 border-gray-600 rounded-full px-4 py-2 text-sm hover:border-[var(--accent-teal)]">🔮 Neon</label></div>
                                </div>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-200 mb-3">Tipe Konten</h4>
                                <div class="flex flex-wrap gap-3">
                                    <div class="creative-option"><input type="radio" name="iklan_content" id="content_hard" value="Hard Selling" class="sr-only" checked><label for="content_hard" class="block cursor-pointer border-2 border-gray-600 rounded-full px-4 py-2 text-sm hover:border-[var(--accent-teal)]">💥 Hard Selling</label></div>
                                    <div class="creative-option"><input type="radio" name="iklan_content" id="content_soft" value="Soft Selling" class="sr-only"><label for="content_soft" class="block cursor-pointer border-2 border-gray-600 rounded-full px-4 py-2 text-sm hover:border-[var(--accent-teal)]">😊 Soft Selling</label></div>
                                    <div class="creative-option"><input type="radio" name="iklan_content" id="content_story" value="Storytelling" class="sr-only"><label for="content_story" class="block cursor-pointer border-2 border-gray-600 rounded-full px-4 py-2 text-sm hover:border-[var(--accent-teal)]">📖 Storytelling</label></div>
                                    <div class="creative-option"><input type="radio" name="iklan_content" id="content_problem" value="Problem/Solution" class="sr-only"><label for="content_problem" class="block cursor-pointer border-2 border-gray-600 rounded-full px-4 py-2 text-sm hover:border-[var(--accent-teal)]">💡 Problem/Solution</label></div>
                                </div>
                            </div>
                         </div>
                    </div>
                    <button type="submit" id="generate-iklan-btn" class="w-full bg-teal-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-teal-600 focus:outline-none focus:ring-4 focus:ring-teal-500/50 transition flex items-center justify-center disabled:bg-gray-600">
                        <span class="btn-text">Buat Aset Iklan</span>
                    </button>
                </form>
                 <div id="iklan-results-container" class="mt-8"></div>
            </div>
            <!-- Review Produk Panel -->
            <div id="panel-review-produk" class="hidden">
                 <form id="review-produk-form" class="space-y-8">
                    <div>
                        <h3 class="text-lg font-semibold text-white mb-2">1. Unggah Aset</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <label id="review-produk-label" class="asset-upload-box">
                                <span id="review-produk-text">🖼️ Unggah Produk</span>
                                <img id="review-produk-preview" class="preview hidden" alt="Preview Produk">
                                <button type="button" id="remove-produk-btn" class="remove-asset-btn hidden">&times;</button>
                            </label>
                            <input type="file" id="review-produk-upload" class="hidden" accept="image/*">
                            
                            <label id="review-wajah-label" class="asset-upload-box">
                                <span id="review-wajah-text">👤 Unggah Wajah</span>
                                <img id="review-wajah-preview" class="preview hidden" alt="Preview Wajah">
                                 <button type="button" id="remove-wajah-btn" class="remove-asset-btn hidden">&times;</button>
                            </label>
                            <input type="file" id="review-wajah-upload" class="hidden" accept="image/*">
                        </div>
                    </div>
                     <div>
                        <h3 class="text-lg font-semibold text-white mb-2">2. Deskripsi Produk</h3>
                        <textarea id="review-deskripsi" rows="3" class="w-full px-3 py-2 bg-[var(--bg-dark)] border border-gray-600 rounded-lg focus:ring-2 focus:ring-[var(--accent-teal)] text-white transition" placeholder="Contoh: Sepatu sneakers seri Z, nyaman untuk olahraga dan hangout."></textarea>
                    </div>
                     <div>
                         <h3 class="text-lg font-semibold text-white mb-4">3. Vibe Latar Belakang</h3>
                         <div id="review-vibe-container" class="flex flex-wrap gap-3 max-h-48 overflow-y-auto p-2 bg-black/20 rounded-lg">
                            <!-- Vibe options will be injected here by JS -->
                         </div>
                     </div>
                      <button type="submit" id="generate-review-btn" class="w-full bg-orange-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-orange-600 focus:outline-none focus:ring-4 focus:ring-orange-500/50 transition flex items-center justify-center disabled:bg-gray-600">
                        <span class="btn-text">Generate Konten Review</span>
                    </button>
                 </form>
                 <div id="review-results-container" class="mt-8"></div>
            </div>
             <!-- Batch Text to Image Panel -->
            <div id="panel-text-to-image" class="hidden">
                <form id="text-to-image-form">
                     <div class="mb-4">
                        <label for="model-select-image" class="block text-sm font-medium text-[var(--text-primary)] mb-2">Pilih Model Gambar</label>
                        <select id="model-select-image" class="w-full px-3 py-2 bg-[var(--bg-dark)] border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--accent-lime)] text-white">
                            <option value="imagen-4.0-ultra-generate-preview-06-06">Imagen 4 Ultra</option>
                            <option value="imagen-4.0-generate-preview-06-06">Imagen 4</option>
                            <option value="imagen-3.0-generate-002">Imagen 3</option>
                        </select>
                    </div>
                     <div class="mb-4">
                        <label for="aspect-ratio-select-image-gen" class="block text-sm font-medium text-[var(--text-primary)] mb-2">Aspek Rasio</label>
                        <select id="aspect-ratio-select-image-gen" class="w-full px-3 py-2 bg-[var(--bg-dark)] border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--accent-lime)] text-white">
                            <option value="16:9">16:9 (Landscape)</option>
                            <option value="9:16">9:16 (Portrait)</option>
                            <option value="1:1">1:1 (Square)</option>
                            <option value="4:3">4:3</option>
                            <option value="3:4">3:4</option>
                        </select>
                    </div>
                    <div class="mb-6">
                        <label for="image-prompts" class="block text-sm font-medium text-[var(--text-primary)] mb-2">Prompts (satu per baris)</label>
                        <textarea id="image-prompts" name="image-prompts" rows="8" class="w-full px-3 py-2 bg-[var(--bg-dark)] border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--accent-lime)] text-white transition" placeholder="A photorealistic image of a majestic lion..." required></textarea>
                        <p class="text-xs text-[var(--text-secondary)] mt-1 text-right">Jumlah Prompt: <span id="prompt-count-image">0</span></p>
                    </div>
                    <div>
                        <button type="submit" id="generate-btn-text-to-image" class="w-full bg-pink-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-pink-700 focus:outline-none focus:ring-4 focus:ring-pink-500/50 transition-all duration-300 ease-in-out flex items-center justify-center disabled:bg-gray-600">
                            <span class="btn-text">Generate Gambar dari Teks</span>
                        </button>
                    </div>
                </form>
            </div>
            <!-- JSON Prompt Panel -->
            <div id="panel-json-prompt" class="hidden">
                <form id="json-form">
                    <div class="mb-4">
                        <label for="model-select-video-json" class="block text-sm font-medium text-[var(--text-primary)] mb-2">Pilih Model Video</label>
                        <select id="model-select-video-json" class="w-full px-3 py-2 bg-[var(--bg-dark)] border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--accent-lime)] text-white">
                            <option value="veo-3.0-generate-preview">Veo 3</option>
                            <option value="veo-3.0-fast-generate-preview">Veo 3 (Cepat)</option>
                            <option value="veo-2.0-generate-001">Veo 2</option>
                        </select>
                    </div>
                    <div id="veo2-settings-container-json" class="space-y-4 mb-4 hidden">
                        <div>
                            <label for="duration-select-json" class="block text-sm font-medium text-[var(--text-primary)] mb-2">Durasi Video (untuk Veo 2)</label>
                            <select id="duration-select-json" class="w-full px-3 py-2 bg-[var(--bg-dark)] border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--accent-lime)] text-white">
                                <option value="5">5 detik</option>
                                <option value="6">6 detik</option>
                                <option value="7">7 detik</option>
                                <option value="8">8 detik</option>
                            </select>
                        </div>
                        <div>
                           <label for="aspect-ratio-select-veo2-json" class="block text-sm font-medium text-[var(--text-primary)] mb-2">Aspek Rasio (untuk Veo 2)</label>
                            <select id="aspect-ratio-select-veo2-json" class="w-full px-3 py-2 bg-[var(--bg-dark)] border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--accent-lime)] text-white">
                                <option value="16:9">16:9 (Landscape)</option>
                                <option value="9:16">9:16 (Portrait)</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-6">
                        <label for="json-prompt-input" class="block text-sm font-medium text-[var(--text-primary)] mb-2">Single Prompt (Bisa berisi JSON)</label>
                        <textarea id="json-prompt-input" rows="12" class="w-full px-3 py-2 bg-[var(--bg-dark)] border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--accent-lime)] text-white font-mono text-xs" placeholder='Contoh: A cinematic shot of a cat astronaut floating in space, audio: space ambient sounds' required></textarea>
                    </div>
                    <div>
                        <button type="submit" id="generate-btn-json" class="w-full bg-orange-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-orange-700 focus:outline-none focus:ring-4 focus:ring-orange-500/50 transition-all duration-300 ease-in-out flex items-center justify-center disabled:bg-gray-600">
                            <span class="btn-text">Generate dari Prompt Tunggal</span>
                        </button>
                    </div>
                </form>
            </div>
            <!-- Image to Image Panel -->
            <div id="panel-image-to-image" class="hidden">
                <form id="image-to-image-form">
                    <div class="flex flex-col sm:flex-row gap-6 mb-6">
                        <div class="flex-shrink-0">
                            <label for="i2i-upload-input" class="image-preview cursor-pointer" id="i2i-preview">
                                <span>Upload Gambar Referensi</span>
                            </label>
                            <input type="file" id="i2i-upload-input" class="hidden" accept="image/*" required>
                        </div>
                        <div class="flex-grow space-y-4">
                            <div>
                                <label for="i2i-prompt" class="block text-sm font-medium text-[var(--text-primary)] mb-2">Prompt</label>
                                <textarea id="i2i-prompt" rows="3" class="w-full px-3 py-2 bg-[var(--bg-dark)] border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--accent-lime)] text-white" placeholder="Contoh: a cute cat wearing a wizard hat" required></textarea>
                            </div>
                            <div>
                                <label for="i2i-negative-prompt" class="block text-sm font-medium text-[var(--text-primary)] mb-2">Negative Prompt</label>
                                <input type="text" id="i2i-negative-prompt" class="w-full px-3 py-2 bg-[var(--bg-dark)] border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--accent-lime)] text-white" placeholder="Contoh: blurry, ugly, text">
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                         <div>
                            <label for="i2i-aspect-ratio" class="block text-sm font-medium text-[var(--text-primary)] mb-2">Aspect Ratio</label>
                            <select id="i2i-aspect-ratio" class="w-full px-3 py-2 bg-[var(--bg-dark)] border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--accent-lime)] text-white">
                                <option value="9:16">9:16 (Portrait)</option>
                                <option value="16:9">16:9 (Landscape)</option>
                                <option value="1:1">1:1 (Square)</option>
                                <option value="4:3">4:3</option>
                                <option value="3:4">3:4</option>
                            </select>
                        </div>
                        <div>
                            <label for="i2i-sample-count" class="block text-sm font-medium text-[var(--text-primary)] mb-2">Jumlah Hasil Generate</label>
                            <select id="i2i-sample-count" class="w-full px-3 py-2 bg-[var(--bg-dark)] border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--accent-lime)] text-white">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <button type="submit" id="generate-btn-i2i" class="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-700 focus:outline-none focus:ring-4 focus:ring-purple-500/50 transition-all duration-300 ease-in-out flex items-center justify-center disabled:bg-gray-600">
                            <span class="btn-text">Generate Image to Image</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div id="processing-actions-container" class="my-6 hidden">
            <button id="cancel-btn" class="w-full bg-red-600/50 text-red-300 border border-red-500/60 hover:bg-red-500/60 hover:text-white font-bold py-3 px-4 rounded-lg transition-all">Batalkan Semua Proses</button>
        </div>
        
        <div id="results-container" class="pb-4"></div>
        
        <div id="post-processing-actions-container" class="my-6 hidden">
             <button id="retry-all-btn" class="w-full bg-yellow-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-yellow-700">Retry All Error Generate</button>
        </div>

        <div id="download-all-container" class="mt-6 hidden pb-20">
            <div class="flex flex-col sm:flex-row gap-2">
                <button id="download-all-zip-btn" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700">Download Semua sebagai .zip</button>
                <button id="download-all-files-btn" class="w-full bg-sky-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-sky-700">Download Semua File</button>
            </div>
            <p class="text-xs text-center text-[var(--text-secondary)] mt-2">Untuk download individual, browser Anda mungkin akan meminta izin untuk mengunduh beberapa file sekaligus.</p>
        </div>
    </div>

    <!-- Gemini AI Modal -->
    <div id="gemini-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div id="modal-content" class="bg-[var(--bg-panel)] rounded-2xl shadow-2xl w-full max-w-2xl transform transition-all p-6 modal-enter border border-[var(--border-color)]">
            <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold text-white">✨ Asisten Prompt Gemini</h2><button id="close-gemini-modal-btn" class="text-[var(--text-secondary)] hover:text-white text-3xl leading-none">&times;</button></div>
            <div class="mb-6 border-b border-[var(--border-color)]"><nav class="flex space-x-2 sm:space-x-4" aria-label="Tabs"><button id="tab-enhance" class="px-3 py-2 font-medium text-xs sm:text-sm rounded-md text-black bg-[var(--accent-lime)]">Tingkatkan Prompt</button><button id="tab-ideas" class="px-3 py-2 font-medium text-xs sm:text-sm rounded-md text-[var(--text-secondary)] hover:text-white">Hasilkan Ide</button><button id="tab-story" class="px-3 py-2 font-medium text-xs sm:text-sm rounded-md text-[var(--text-secondary)] hover:text-white">Buat Cerita Batch</button></nav></div>
            <div id="content-enhance"><p class="text-sm text-[var(--text-secondary)] mb-2">Masukkan ide sederhana, dan Gemini akan mengubahnya menjadi prompt Veo 3 yang detail dalam satu baris.</p><textarea id="enhance-input" rows="3" class="w-full px-3 py-2 bg-[var(--bg-dark)] border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--accent-lime)] text-white" placeholder="Contoh: kucing di luar angkasa"></textarea><button id="enhance-btn" class="mt-3 w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 flex items-center justify-center">Tingkatkan dengan Gemini</button></div>
            <div id="content-ideas" class="hidden"><p class="text-sm text-[var(--text-secondary)] mb-2">Masukkan sebuah tema, dan Gemini akan memberikan 3 ide prompt video yang kreatif untuk Veo 3.</p><input type="text" id="ideas-input" class="w-full px-3 py-2 bg-[var(--bg-dark)] border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--accent-lime)] text-white" placeholder="Contoh: fantasi bawah air"><button id="ideas-btn" class="mt-3 w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 flex items-center justify-center">Hasilkan Ide</button></div>
            <div id="content-story" class="hidden"><p class="text-sm text-[var(--text-secondary)] mb-2">Masukkan ide cerita, dan Gemini akan membuat 5 prompt berurutan untuk film pendek Anda.</p<textarea id="story-input" rows="3" class="w-full px-3 py-2 bg-[var(--bg-dark)] border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--accent-lime)] text-white" placeholder="Contoh: seorang detektif memecahkan misteri di kota cyberpunk"></textarea><button id="story-btn" class="mt-3 w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 flex items-center justify-center">Buat Alur Cerita</button></div>
            <div id="gemini-result-area" class="mt-4 hidden"><h3 class="text-lg font-semibold text-white mb-2">Hasil dari Gemini:</h3><div id="gemini-loader" class="flex justify-center items-center p-4"><div class="loader"></div></div><div id="gemini-output" class="text-sm bg-black/30 p-4 rounded-lg whitespace-pre-wrap font-mono text-[var(--text-primary)]"></div><button id="use-prompt-btn" class="mt-3 w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 hidden">Gunakan Prompt Ini</button></div>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="error-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-[var(--bg-panel)] rounded-2xl shadow-2xl w-full max-w-md transform transition-all p-6 modal-enter border border-red-500/50">
            <div class="flex items-center mb-4"><div class="flex-shrink-0 bg-red-500/20 text-red-400 rounded-full p-2"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg></div><h2 class="text-xl font-bold text-white ml-4">Terjadi Masalah</h2></div>
            <p id="error-message-text" class="text-[var(--text-primary)] mb-6">Pesan error akan muncul di sini.</p>
            <button id="close-error-modal-btn" class="w-full bg-[var(--accent-lime)] text-black font-bold py-2 px-4 rounded-lg hover:bg-[var(--accent-lime-hover)]">Mengerti</button>
        </div>
    </div>

     <!-- Preview Modal -->
    <div id="preview-modal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-gray-900 rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b border-gray-700">
                <h3 class="text-lg font-semibold text-white">Preview</h3>
                <button id="close-preview-modal-btn" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <div id="preview-content" class="p-4 flex-grow overflow-auto flex items-center justify-center">
                <!-- Preview image or video will be inserted here -->
            </div>
        </div>
    </div>


    <script>
        // --- DOM Elements ---
        const appContainer = document.getElementById('app-container');
        const passwordModal = document.getElementById('password-modal');
        const passwordForm = document.getElementById('password-form');
        const passwordInput = document.getElementById('password-input');
        const passwordError = document.getElementById('password-error');
        const apiKeyInput = document.getElementById('api-keys');
        const modelSelectVideoText = document.getElementById('model-select-video-text');
        const modelSelectVideoImage = document.getElementById('model-select-video-image');
        const modelSelectImage = document.getElementById('model-select-image');
        const veo2SettingsContainerText = document.getElementById('veo2-settings-container-text');
        const veo2SettingsContainerImage = document.getElementById('veo2-settings-container-image');
        const durationSelectText = document.getElementById('duration-select-text');
        const durationSelectImage = document.getElementById('duration-select-image');
        const aspectRatioSelectVeo2Text = document.getElementById('aspect-ratio-select-veo2-text');
        const aspectRatioSelectVeo2Image = document.getElementById('aspect-ratio-select-veo2-image');
        const resultsContainer = document.getElementById('results-container');
        const textForm = document.getElementById('prompt-form');
        const promptsInput = document.getElementById('prompts');
        const generateBtnText = document.getElementById('generate-btn-text');
        const imageForm = document.getElementById('image-form');
        const imageUploadsContainer = document.getElementById('image-uploads-container');
        const batchImageUploadInput = document.getElementById('batch-image-upload');
        const generateAllPromptsBtn = document.getElementById('generate-all-prompts-btn');
        const generateBtnImage = document.getElementById('generate-btn-image');
        const textToImageForm = document.getElementById('text-to-image-form');
        const imagePromptsInput = document.getElementById('image-prompts');
        const generateBtnTextToImage = document.getElementById('generate-btn-text-to-image');
        const mainTabTextToVideo = document.getElementById('main-tab-text-to-video');
        const mainTabImageToVideo = document.getElementById('main-tab-image-to-video');
        const mainTabIklanGenerator = document.getElementById('main-tab-iklan-generator');
        const mainTabReviewProduk = document.getElementById('main-tab-review-produk');
        const mainTabTextToImage = document.getElementById('main-tab-text-to-image');
        const mainTabJsonPrompt = document.getElementById('main-tab-json-prompt');
        const mainTabImageToImage = document.getElementById('main-tab-image-to-image');
        const panelTextToVideo = document.getElementById('panel-text-to-video');
        const panelImageToVideo = document.getElementById('panel-image-to-video');
        const panelIklanGenerator = document.getElementById('panel-iklan-generator');
        const panelReviewProduk = document.getElementById('panel-review-produk');
        const panelTextToImage = document.getElementById('panel-text-to-image');
        const panelJsonPrompt = document.getElementById('panel-json-prompt');
        const panelImageToImage = document.getElementById('panel-image-to-image');
        const iklanGeneratorForm = document.getElementById('iklan-generator-form');
        const iklanBatchUploadInput = document.getElementById('iklan-batch-upload');
        const iklanPreviewContainer = document.getElementById('iklan-preview-container');
        const iklanDeskripsi = document.getElementById('iklan-deskripsi');
        const generateIklanBtn = document.getElementById('generate-iklan-btn');
        const iklanResultsContainer = document.getElementById('iklan-results-container');
        const reviewProdukForm = document.getElementById('review-produk-form');
        const reviewProdukUpload = document.getElementById('review-produk-upload');
        const reviewWajahUpload = document.getElementById('review-wajah-upload');
        const reviewDeskripsi = document.getElementById('review-deskripsi');
        const generateReviewBtn = document.getElementById('generate-review-btn');
        const reviewResultsContainer = document.getElementById('review-results-container');
        const reviewVibeContainer = document.getElementById('review-vibe-container');
        const imageToImageForm = document.getElementById('image-to-image-form');
        const i2iUploadInput = document.getElementById('i2i-upload-input');
        const i2iPreview = document.getElementById('i2i-preview');
        const i2iPrompt = document.getElementById('i2i-prompt');
        const i2iNegativePrompt = document.getElementById('i2i-negative-prompt');
        const i2iAspectRatio = document.getElementById('i2i-aspect-ratio');
        const i2iSampleCount = document.getElementById('i2i-sample-count');
        const generateBtnI2I = document.getElementById('generate-btn-i2i');
        const jsonForm = document.getElementById('json-form');
        const jsonPromptInput = document.getElementById('json-prompt-input');
        const generateBtnJson = document.getElementById('generate-btn-json');
        const geminiModal = document.getElementById('gemini-modal');
        const modalContent = document.getElementById('modal-content');
        const openModalBtn = document.getElementById('open-gemini-modal-btn');
        const closeModalBtn = document.getElementById('close-gemini-modal-btn');
        const tabEnhance = document.getElementById('tab-enhance');
        const tabIdeas = document.getElementById('tab-ideas');
        const tabStory = document.getElementById('tab-story');
        const contentEnhance = document.getElementById('content-enhance');
        const contentIdeas = document.getElementById('content-ideas');
        const contentStory = document.getElementById('content-story');
        const enhanceBtn = document.getElementById('enhance-btn');
        const ideasBtn = document.getElementById('ideas-btn');
        const storyBtn = document.getElementById('story-btn');
        const geminiResultArea = document.getElementById('gemini-result-area');
        const geminiLoader = document.getElementById('gemini-loader');
        const geminiOutput = document.getElementById('gemini-output');
        const usePromptBtn = document.getElementById('use-prompt-btn');
        const errorModal = document.getElementById('error-modal');
        const errorMessageText = document.getElementById('error-message-text');
        const closeErrorModalBtn = document.getElementById('close-error-modal-btn');
        const previewModal = document.getElementById('preview-modal');
        const closePreviewModalBtn = document.getElementById('close-preview-modal-btn');
        const previewContent = document.getElementById('preview-content');
        const downloadAllContainer = document.getElementById('download-all-container');
        const downloadAllZipBtn = document.getElementById('download-all-zip-btn');
        const downloadAllFilesBtn = document.getElementById('download-all-files-btn');
        const processingActionsContainer = document.getElementById('processing-actions-container');
        const postProcessingActionsContainer = document.getElementById('post-processing-actions-container');
        const cancelBtn = document.getElementById('cancel-btn');
        const retryAllBtn = document.getElementById('retry-all-btn');
        const negativePromptInput = document.getElementById('negative-prompt');
        const aspectRatioSelectImageGen = document.getElementById('aspect-ratio-select-image-gen');
        const modelSelectVideoJson = document.getElementById('model-select-video-json');
        const veo2SettingsContainerJson = document.getElementById('veo2-settings-container-json');
        const durationSelectJson = document.getElementById('duration-select-json');
        const aspectRatioSelectVeo2Json = document.getElementById('aspect-ratio-select-veo2-json');
        const promptCountText = document.getElementById('prompt-count-text');
        const promptCountImage = document.getElementById('prompt-count-image');
        const multipleGenerateSelect = document.getElementById('multiple-generate-select');
        const delaySelect = document.getElementById('delay-select');

        const sleep = ms => new Promise(res => setTimeout(res, ms));
        let stopAllProcessing = false;
        let generatedMedia = [];
        let tasksStore = {};
        let uploadedIklanFiles = [];
        let uploadedReviewProductFile = null;
        let uploadedReviewWajahFile = null;

        // --- API Key Manager ---
        const apiKeyManager = {
            keys: [],
            currentIndex: 0,
            init(keysString) {
                this.keys = keysString.trim().split('\n').filter(k => k.trim() !== '');
                this.currentIndex = 0;
            },
            getKey() {
                if (this.keys.length === 0) return null;
                return this.keys[this.currentIndex];
            },
            rotateKey() {
                if (this.keys.length > 1) {
                    this.currentIndex = (this.currentIndex + 1) % this.keys.length;
                    console.log(`Rotated to API key index: ${this.currentIndex}`);
                }
            },
            hasKeys() {
                return this.keys.length > 0;
            }
        };

        // --- Password Protection ---
        const APP_PASSWORD = "kamdowo";
        
        function checkAuth() {
            if (sessionStorage.getItem('isAppAuthenticated') === 'true') {
                passwordModal.classList.add('hidden');
                appContainer.classList.remove('hidden');
            } else {
                passwordModal.classList.remove('hidden');
                appContainer.classList.add('hidden');
            }
        }
        
        passwordForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (passwordInput.value === APP_PASSWORD) {
                sessionStorage.setItem('isAppAuthenticated', 'true');
                checkAuth();
            } else {
                passwordError.classList.remove('hidden');
            }
        });

        // --- Main App Logic ---
        function switchTab(activeTabId) {
            const tabs = { 
                'main-tab-text-to-video': panelTextToVideo, 
                'main-tab-image-to-video': panelImageToVideo,
                'main-tab-iklan-generator': panelIklanGenerator,
                'main-tab-review-produk': panelReviewProduk,
                'main-tab-text-to-image': panelTextToImage,
                'main-tab-json-prompt': panelJsonPrompt,
                'main-tab-image-to-image': panelImageToImage
            };
            const tabButtons = { 
                'main-tab-text-to-video': mainTabTextToVideo, 
                'main-tab-image-to-video': mainTabImageToVideo,
                'main-tab-iklan-generator': mainTabIklanGenerator,
                'main-tab-review-produk': mainTabReviewProduk,
                'main-tab-text-to-image': mainTabTextToImage,
                'main-tab-json-prompt': mainTabJsonPrompt,
                'main-tab-image-to-image': mainTabImageToImage
            };
            const borderColors = { 
                'main-tab-text-to-video': 'border-[var(--accent-lime)]', 
                'main-tab-image-to-video': 'border-blue-500',
                'main-tab-iklan-generator': 'border-teal-500',
                'main-tab-review-produk': 'border-orange-500',
                'main-tab-text-to-image': 'border-pink-500',
                'main-tab-json-prompt': 'border-orange-500',
                'main-tab-image-to-image': 'border-purple-500'
            };
            for (const id in tabs) {
                if (id === activeTabId) {
                    tabs[id].classList.remove('hidden');
                    tabButtons[id].className = `flex-shrink-0 px-3 sm:px-4 py-2 font-medium text-sm rounded-t-lg text-white border-b-2 ${borderColors[id]}`;
                } else {
                    tabs[id].classList.add('hidden');
                    tabButtons[id].className = 'flex-shrink-0 px-3 sm:px-4 py-2 font-medium text-sm rounded-t-lg text-[var(--text-secondary)] hover:text-white';
                }
            }
        }
        mainTabTextToVideo.addEventListener('click', () => switchTab('main-tab-text-to-video'));
        mainTabImageToVideo.addEventListener('click', () => switchTab('main-tab-image-to-video'));
        mainTabIklanGenerator.addEventListener('click', () => switchTab('main-tab-iklan-generator'));
        mainTabReviewProduk.addEventListener('click', () => switchTab('main-tab-review-produk'));
        mainTabTextToImage.addEventListener('click', () => switchTab('main-tab-text-to-image'));
        mainTabJsonPrompt.addEventListener('click', () => switchTab('main-tab-json-prompt'));
        mainTabImageToImage.addEventListener('click', () => switchTab('main-tab-image-to-image'));
        
        document.addEventListener('click', function(event) {
            if (event.target.matches('a[download]')) {
                event.preventDefault();
                const link = document.createElement('a');
                link.href = event.target.href; link.download = event.target.download;
                document.body.appendChild(link); link.click(); document.body.removeChild(link);
            }
        });
        function showErrorModal(message) {
            errorMessageText.textContent = message;
            errorModal.classList.remove('hidden');
        }
        closeErrorModalBtn.addEventListener('click', () => errorModal.classList.add('hidden'));

        function openPreviewModal(contentUrl, type) {
            if (type === 'image') {
                previewContent.innerHTML = `<img src="${contentUrl}" class="max-w-full max-h-full rounded-lg">`;
            } else { // video
                previewContent.innerHTML = `<video controls autoplay class="max-w-full max-h-full rounded-lg"><source src="${contentUrl}" type="video/mp4"></video>`;
            }
            previewModal.classList.remove('hidden');
        }
        closePreviewModalBtn.addEventListener('click', () => {
            previewContent.innerHTML = '';
            previewModal.classList.add('hidden');
        });
        
        // --- Image-to-Video UI Logic ---
        let imageBlockCount = 0;
        
        function addImageBlock(file = null) {
            imageBlockCount++;
            const blockId = `image-block-${imageBlockCount}`;
            const block = document.createElement('div');
            block.id = blockId;
            block.className = 'p-4 border border-[var(--border-color)] rounded-lg mb-4';
            block.innerHTML = `
                <div class="flex flex-col sm:flex-row gap-4">
                    <div class="flex-shrink-0"><label for="file-input-${blockId}" class="image-preview cursor-pointer"><span>Pilih Gambar</span></label><input type="file" id="file-input-${blockId}" class="hidden" accept="image/*"></div>
                    <div class="flex-grow"><label for="image-prompt-${blockId}" class="text-sm font-medium text-[var(--text-primary)] mb-1 block">Prompt untuk Gambar Ini (opsional)</label><textarea id="image-prompt-${blockId}" rows="3" class="w-full px-3 py-2 bg-[var(--bg-dark)] border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--accent-lime)] text-white" placeholder="Kosongkan untuk generate otomatis"></textarea><button type="button" class="generate-prompt-from-image-btn mt-2 text-xs text-[var(--accent-lime)] font-semibold hover:text-[var(--accent-lime-hover)] transition">✨ Buat Prompt dari Gambar</button></div>
                    <div class="flex-shrink-0 self-center"><button type="button" class="remove-image-btn text-red-500 hover:text-red-400" data-block-id="${blockId}">&times; Hapus</button></div>
                </div>`;
            
            imageUploadsContainer.appendChild(block);
            
            const fileInput = document.getElementById(`file-input-${blockId}`);
            const previewEl = fileInput.previousElementSibling;

            const handleFile = (file) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewEl.style.backgroundImage = `url('${e.target.result}')`;
                    previewEl.innerHTML = ''; 
                };
                reader.readAsDataURL(file);
            };

            if (file) {
                // Workaround for environments where the File object might not be correctly recognized.
                // Reconstructing the File object can resolve this.
                const safeFile = new File([file], file.name, { type: file.type, lastModified: file.lastModified });
                
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(safeFile);
                fileInput.files = dataTransfer.files;
                handleFile(safeFile);
            }

            fileInput.addEventListener('change', (event) => {
                const selectedFile = event.target.files[0];
                if (selectedFile) handleFile(selectedFile);
            });
            block.querySelector('.remove-image-btn').addEventListener('click', (event) => { document.getElementById(event.target.dataset.blockId).remove(); });
            block.querySelector('.generate-prompt-from-image-btn').addEventListener('click', handleGeneratePromptFromImage);
        }

        batchImageUploadInput.addEventListener('change', (event) => {
            const files = event.target.files;
            if (!files.length) return;
            const allBlocks = imageUploadsContainer.querySelectorAll('[id^="image-block-"]');
            const firstBlock = allBlocks[0];
            const isFirstBlockEmpty = allBlocks.length === 1 && !firstBlock.querySelector('input[type="file"]').files.length;
            if (isFirstBlockEmpty) {
                firstBlock.remove();
            }
            for (const file of files) {
                addImageBlock(file);
            }
        });

        generateAllPromptsBtn.addEventListener('click', () => {
            apiKeyManager.init(apiKeyInput.value);
            if (!apiKeyManager.hasKeys()) {
                showErrorModal('Mohon isi API Key terlebih dahulu.');
                return;
            }
            document.querySelectorAll('.generate-prompt-from-image-btn').forEach(btn => btn.click());
        });
        window.addEventListener('DOMContentLoaded', addImageBlock);

        // --- Gemini API Functionality ---
        async function callGeminiApi(payload, apiKey) {
            const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const response = await fetch(GEMINI_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) { const errorData = await response.json(); throw new Error(`Gemini API Error: ${errorData.error?.message || 'Unknown error'}`); }
            const result = await response.json();
            return result.candidates[0].content.parts[0].text.trim();
        }
        openModalBtn.addEventListener('click', () => { modalContent.classList.remove('modal-leave'); modalContent.classList.add('modal-enter'); geminiModal.classList.remove('hidden'); });
        closeModalBtn.addEventListener('click', () => { modalContent.classList.add('modal-leave'); modalContent.classList.remove('modal-enter'); setTimeout(() => { geminiModal.classList.add('hidden'); }, 300); });
        
        function switchGeminiTab(activeTab) {
            [tabEnhance, tabIdeas, tabStory].forEach(tab => {
                tab.className = 'px-3 py-2 font-medium text-xs sm:text-sm rounded-md text-[var(--text-secondary)] hover:text-white';
            });
            [contentEnhance, contentIdeas, contentStory].forEach(content => content.classList.add('hidden'));
            activeTab.className = 'px-3 py-2 font-medium text-xs sm:text-sm rounded-md text-black bg-[var(--accent-lime)]';
            document.getElementById(activeTab.id.replace('tab-', 'content-')).classList.remove('hidden');
            geminiResultArea.classList.add('hidden');
        }
        tabEnhance.addEventListener('click', () => switchGeminiTab(tabEnhance));
        tabIdeas.addEventListener('click', () => switchGeminiTab(tabIdeas));
        tabStory.addEventListener('click', () => switchGeminiTab(tabStory));

        const handleGeminiRequest = async (inputElement, promptGenerator) => {
            const userInput = inputElement.value.trim(); 
            if (!userInput) { alert("Mohon masukkan input Anda."); return; }
            apiKeyManager.init(apiKeyInput.value);
            const apiKey = apiKeyManager.getKey();
            if (!apiKey) { alert("Mohon masukkan API Key Anda."); return; }
            const fullPrompt = promptGenerator(userInput);
            geminiResultArea.classList.remove('hidden'); geminiLoader.classList.remove('hidden'); geminiOutput.classList.add('hidden'); usePromptBtn.classList.add('hidden');
            try { const payload = { contents: [{ parts: [{ text: fullPrompt }] }] }; const result = await callGeminiApi(payload, apiKey); geminiOutput.textContent = result; usePromptBtn.classList.remove('hidden'); } catch (error) { geminiOutput.textContent = `Error: ${error.message}`; } finally { geminiLoader.classList.add('hidden'); geminiOutput.classList.remove('hidden'); }
        };
        enhanceBtn.addEventListener('click', () => handleGeminiRequest(document.getElementById('enhance-input'), (input) => `Anda adalah seorang penulis skenario ahli untuk model AI text-to-video Veo. Ubah ide dasar berikut menjadi satu prompt sinematik yang sangat detail dalam **satu baris tunggal**. Prompt harus dalam bahasa Inggris dan wajib menyertakan deskripsi audio yang spesifik dan relevan di akhir prompt, dengan format \`, audio: [deskripsi audio]\`. Contoh: \`A hyper-detailed cinematic shot of a futuristic city at night, rain-slicked streets reflecting neon signs, flying cars weaving through skyscrapers, audio: sound of pouring rain, humming of futuristic vehicles, synthwave music.\` Ide dasar: "${input}"`));
        ideasBtn.addEventListener('click', () => handleGeminiRequest(document.getElementById('ideas-input'), (input) => `Anda adalah seorang brainstormer kreatif untuk model AI text-to-video Veo. Buat **tepat 3 ide prompt** yang unik berdasarkan tema berikut. Setiap prompt harus berada di baris baru, dalam bahasa Inggris, dan wajib menyertakan deskripsi audio yang spesifik dan relevan di akhir setiap prompt dengan format \`, audio: [deskripsi audio]\`. **Jangan sertakan teks pengantar atau penutup apa pun, hanya daftar prompt saja.** Contoh: \`A majestic dragon soaring through a stormy sky, lightning flashes revealing its iridescent scales, audio: thunder roars, powerful wing beats, epic orchestral score.\` Tema: "${input}"`));
        storyBtn.addEventListener('click', () => handleGeminiRequest(document.getElementById('story-input'), (input) => `Anda adalah seorang penulis skenario untuk film pendek. Berdasarkan ide cerita berikut, buat **tepat 5 prompt video berurutan** untuk model Veo yang menceritakan sebuah kisah yang koheren. Setiap prompt harus berada di baris baru, dalam bahasa Inggris, dan menyertakan deskripsi audio spesifik dengan format \`, audio: [deskripsi audio]\`. **Jangan sertakan teks pengantar atau penutup apa pun, hanya daftar prompt saja.** Ide Cerita: "${input}"`));
        usePromptBtn.addEventListener('click', () => { 
            const newPrompts = geminiOutput.textContent.split('\n').filter(p => p.trim().includes(', audio:')).join('\n');
            if (promptsInput.value.trim() !== '') { 
                promptsInput.value += '\n' + newPrompts; 
            } else { 
                promptsInput.value = newPrompts; 
            } 
            closeModalBtn.click(); 
        });
        
        async function handleGeneratePromptFromImage(event) {
            apiKeyManager.init(apiKeyInput.value);
            const button = event.target;
            const block = button.closest('[id^="image-block-"]');
            const fileInput = block.querySelector('input[type="file"]');
            const promptTextarea = block.querySelector('textarea');
            const file = fileInput.files[0];
            const apiKey = apiKeyManager.getKey();

            const creativeVibe = document.getElementById('creative-vibe').value;
            const creativeLighting = document.getElementById('creative-lighting').value;
            const creativeContentType = document.getElementById('creative-content-type').value;

            if (!file) { showErrorModal("Pilih gambar terlebih dahulu."); return; }
            if (!apiKey) { showErrorModal("Masukkan API Key Anda."); return; }
            button.disabled = true;
            button.textContent = 'Menganalisis...';
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                const base64Data = e.target.result.split(',')[1];
                const mimeType = file.type;
                const selectedModel = modelSelectVideoImage.value;
                let geminiPrompt;

                if (selectedModel.includes('veo-3.0')) {
                    geminiPrompt = `
You are an expert creative director for product video ads. Analyze this product image and generate a single, compelling video prompt for the Veo model.

Strictly follow this creative direction:
- Vibe: "${creativeVibe}"
- Lighting: "${creativeLighting}"
- Content Type: "${creativeContentType}"

Your task is to:
1. Describe the main subject (the product) from the image.
2. Construct a scenario or scene that perfectly matches the creative direction provided above.
3. Ensure the motion described feels natural and fits the content type.
4. Conclude with a specific and relevant audio description in the format: \`, audio: [audio description]\`.

Respond ONLY with the complete video prompt in a single line, in English.`;
                } else { // For Veo 2
                    geminiPrompt = `
You are an expert creative director for product video ads. Analyze this product image and generate a single, compelling video prompt for the Veo 2 model.

Strictly follow this creative direction:
- Vibe: "${creativeVibe}"
- Lighting: "${creativeLighting}"
- Content Type: "${creativeContentType}"

Your task is to:
1. Describe the main subject (the product) from the image.
2. Construct a scenario or scene that perfectly matches the creative direction provided above.
3. Ensure the motion described feels natural and fits the content type.

Respond ONLY with the complete video prompt in a single line, in English. Do not include an audio description.`;
                }

                const payload = {
                    contents: [{
                        parts: [
                            { text: geminiPrompt },
                            { inlineData: { mimeType: mimeType, data: base64Data } }
                        ]
                    }]
                };

                try {
                    const result = await callGeminiApi(payload, apiKey);
                    promptTextarea.value = result;
                }
                catch (error) {
                    showErrorModal(`Gagal membuat prompt: ${error.message}`);
                }
                finally {
                    button.disabled = false;
                    button.textContent = '✨ Buat Prompt dari Gambar';
                }
            };
            reader.readAsDataURL(file);
        }

        // --- Main Generation Logic ---
        function updateResult(promptId, promptText, status, details = '', mediaUrl = null, mediaType = 'video') {
            let resultCard = document.getElementById(promptId);
            if (!resultCard) { 
                resultCard = document.createElement('div'); 
                resultCard.id = promptId; 
                resultCard.className = 'bg-[var(--bg-panel)] p-4 sm:p-5 rounded-xl shadow-lg mb-4 relative border border-[var(--border-color)]'; 
                resultsContainer.appendChild(resultCard); 
            }
            resultCard.dataset.fullPrompt = promptText;

            let statusColor = 'text-yellow-400'; let statusIcon = `<div class="loader"></div>`;
            let actionButton = '';
            if (status === 'Selesai') { 
                statusColor = 'text-green-400'; 
                statusIcon = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`; 
            } 
            else if (status === 'Error' || status === 'Dibatalkan') { 
                statusColor = 'text-red-400'; 
                statusIcon = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                if (status === 'Error') {
                    actionButton = `<button type="button" class="retry-btn mt-2 text-xs bg-yellow-600 hover:bg-yellow-700 text-white font-semibold py-1 px-3 rounded-md" data-prompt-id="${promptId}">Coba Lagi</button>`;
                }
            }
            
            let mediaElement = '';
            if (mediaUrl) { 
                const safeName = promptText.substring(0, 30).replace(/[^a-z0-9]/gi, '_');
                if (mediaType === 'video') {
                    mediaElement = `<div class="mt-4"><video controls class="w-full rounded-lg" preload="metadata" src="${mediaUrl}"></video><a href="${mediaUrl}" download="${safeName}.mp4" class="mt-3 inline-block w-full text-center bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition">Download Video</a></div>`; 
                } else {
                    mediaElement = `<div class="mt-4"><img src="${mediaUrl}" class="w-full rounded-lg"><a href="${mediaUrl}" download="${safeName}.png" class="mt-3 inline-block w-full text-center bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition">Download Gambar</a></div>`;
                }
            }

            const simplifiedPrompt = promptText.length > 100 ? promptText.substring(0, 100) + '...' : promptText;

            resultCard.innerHTML = `
                <div class="flex items-start space-x-4">
                    <div class="flex-shrink-0 ${statusColor}">${statusIcon}</div>
                    <div class="flex-grow">
                        <p class="font-semibold text-white pr-6">${simplifiedPrompt}</p>
                        <p class="text-sm ${statusColor}">${status}</p>
                        ${details ? `<p class="text-xs text-[var(--text-secondary)] mt-1">${details}</p>` : ''}
                        ${actionButton}
                    </div>
                </div>
                <button type="button" class="delete-result-btn absolute top-4 right-4 text-2xl text-[var(--text-secondary)] hover:text-white leading-none transition-colors" data-prompt-id="${promptId}">&times;</button>
                ${mediaElement}`;
        }
        
        async function processGeneration(taskDetails) {
            const { id, payload, originalPrompt, modelName, isVideo, apiMethod } = taskDetails;
            tasksStore[id] = taskDetails;

            if (stopAllProcessing) { updateResult(id, originalPrompt, 'Dibatalkan', 'Proses dihentikan oleh pengguna.'); return null; }
            updateResult(id, originalPrompt, 'Processing', 'Memulai proses...');
            
            const totalKeys = apiKeyManager.keys.length;
            for (let i = 0; i < totalKeys; i++) {
                const apiKey = apiKeyManager.getKey();
                if (!apiKey) {
                    updateResult(id, originalPrompt, 'Error', 'Tidak ada API Key yang valid tersisa.');
                    throw new Error("NO_VALID_KEYS");
                }

                let API_URL;
                if (apiMethod === 'generateContent') {
                    API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;
                } else if (isVideo) {
                    API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:predictLongRunning?key=${apiKey}`;
                } else {
                    API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:predict?key=${apiKey}`;
                }

                try {
                    const startResponse = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    
                    if (!startResponse.ok) {
                        const errorText = await startResponse.text();
                        const errorJson = JSON.parse(errorText);
                        const errorMessage = errorJson.error?.message || 'Gagal memulai.';
                        if (errorMessage.toLowerCase().includes("quota")) {
                            throw new Error("QUOTA_EXCEEDED");
                        }
                        if (errorMessage.includes("Image in input is not supported for this model")) {
                             throw new Error("Model yang dipilih tidak mendukung input gambar.");
                        }
                        throw new Error(errorMessage);
                    }

                    // Handle generateContent for Image-to-Image (Gemini)
                    if (apiMethod === 'generateContent') {
                        const result = await startResponse.json();
                        const base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
                        if (base64Data) {
                            const imageUrl = `data:image/png;base64,${base64Data}`;
                            const mediaResponse = await fetch(imageUrl);
                            const mediaBlob = await mediaResponse.blob();
                            return { mediaBlob, promptText: originalPrompt, mediaType: 'image' };
                        } else {
                            throw new Error('Respons API image-to-image tidak valid.');
                        }
                    }

                    // Handle predict for Text-to-Image AND Image-to-Image with Imagen
                    if (!isVideo) {
                        const result = await startResponse.json();
                        if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                            const imageUrl = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                            const mediaResponse = await fetch(imageUrl);
                            const mediaBlob = await mediaResponse.blob();
                            return { mediaBlob, promptText: originalPrompt, mediaType: 'image' };
                        } else {
                            throw new Error('Respons API gambar tidak valid.');
                        }
                    }

                    // Handle predictLongRunning for Video
                    const startData = await startResponse.json(); const operationName = startData.name;
                    if (!operationName) throw new Error('Tidak menerima operation name dari API.');
                    updateResult(id, originalPrompt, 'Processing', `Proses dimulai. ID: ${operationName.split('/').pop()}. Menunggu hasil...`);
                    let isDone = false; let finalData;
                    while (!isDone) {
                        if (stopAllProcessing) { updateResult(id, originalPrompt, 'Dibatalkan', 'Proses dihentikan.'); return null; }
                        await sleep(10000);
                        const statusUrl = `https://generativelanguage.googleapis.com/v1beta/${operationName}?key=${apiKey}`;
                        const statusResponse = await fetch(statusUrl);
                        if (!statusResponse.ok) { console.error(`Polling gagal untuk ${id}, mencoba lagi...`); continue; }
                        const statusData = await statusResponse.json();
                        if (statusData.done) { isDone = true; finalData = statusData; } else { updateResult(id, originalPrompt, 'Processing', 'Video sedang dirender oleh server...'); }
                    }
                    if (finalData.error) throw new Error(`API Error saat rendering: ${finalData.error.message}`);
                    const videoUri = finalData.response?.generateVideoResponse?.generatedSamples?.[0]?.video?.uri;
                    if (!videoUri) { const raiFiltered = finalData.response?.generateVideoResponse?.raiMediaFilteredReasons?.[0]; if(raiFiltered) throw new Error(`Dibatalkan karena kebijakan keamanan: ${raiFiltered}`); throw new Error('Respons API tidak mengandung URI video.'); }
                    updateResult(id, originalPrompt, 'Processing', 'Mengunduh video...');
                    const videoResponse = await fetch(videoUri, { headers: { 'x-goog-api-key': apiKey } });
                    if (!videoResponse.ok) throw new Error('Gagal mengunduh data video.');
                    const mediaBlob = await videoResponse.blob(); 
                    return { mediaBlob, promptText: originalPrompt, mediaType: 'video' };

                } catch (error) { 
                    console.error(`Error untuk prompt "${originalPrompt}" dengan key index ${apiKeyManager.currentIndex}:`, error);
                    if (error.message === "QUOTA_EXCEEDED") {
                        apiKeyManager.rotateKey();
                        if (i === totalKeys - 1) { // This was the last key
                            const finalError = new Error("Semua API Key telah mencapai kuota.");
                            updateResult(id, originalPrompt, 'Error', finalError.message);
                            throw finalError; // Throw so the caller knows it failed completely
                        }
                        continue; // Try next key
                    }
                    updateResult(id, originalPrompt, 'Error', `API Error: ${error.message}`); 
                    throw error; // Re-throw other errors to be caught by caller
                }
            }
            // This part is reached if all keys failed due to quota
            const finalQuotaError = new Error("Semua API Key telah mencapai kuota.");
            updateResult(id, originalPrompt, 'Error', finalQuotaError.message);
            throw finalQuotaError;
        }
        
        function removePromptFromTextarea(promptToRemove, textareaElement) {
            let currentPrompts = textareaElement.value.split('\n');
            const indexToRemove = currentPrompts.findIndex(p => p.trim() === promptToRemove.trim());
            if (indexToRemove > -1) {
                currentPrompts.splice(indexToRemove, 1);
                textareaElement.value = currentPrompts.join('\n');
                updatePromptCount(textareaElement, textareaElement.nextElementSibling.querySelector('span'));
            }
        }

        async function runBatchProcessing(tasks, batchSize, processFunction, btn, textareaElement = null) {
            btn.disabled = true;
            processingActionsContainer.classList.remove('hidden');
            postProcessingActionsContainer.classList.add('hidden');
            stopAllProcessing = false;
            tasksStore = {};
            const delaySeconds = parseInt(delaySelect.value, 10);
            apiKeyManager.init(apiKeyInput.value); // Init keys before starting

            try {
                for (let i = 0; i < tasks.length; i += batchSize) {
                    if (stopAllProcessing) break;
                    
                    const batch = tasks.slice(i, i + batchSize);
                    const batchPromises = batch.map(task => processFunction(task).then(result => {
                        if (result && textareaElement) {
                            removePromptFromTextarea(task.originalPrompt, textareaElement);
                        }
                        return result;
                    }));

                    await Promise.all(batchPromises);

                    if (i + batchSize < tasks.length) {
                        await sleep(delaySeconds * 1000);
                    }
                }
            } catch (error) {
                 showErrorModal(`Terjadi error tak terduga: ${error.message}`);
            } finally {
                 btn.disabled = false;
                 processingActionsContainer.classList.add('hidden');
                 if (document.querySelector('.retry-btn')) {
                    postProcessingActionsContainer.classList.remove('hidden');
                 }
                 if (generatedMedia.length > 0) {
                     downloadAllContainer.classList.remove('hidden');
                 }
            }
        }

        textForm.addEventListener('submit', async (event) => {
            event.preventDefault(); 
            const modelName = modelSelectVideoText.value;
            const promptsFromTextarea = promptsInput.value.trim().split('\n').filter(p => p.trim() !== '');
            if (promptsFromTextarea.length === 0) { alert('Mohon isi setidaknya satu prompt.'); return; }
            resultsContainer.innerHTML = ''; 
            
            const tasks = promptsFromTextarea.map((p, i) => {
                const parameters = { sampleCount: 1, negativePrompt: negativePromptInput.value.trim() || undefined };
                if (modelName === 'veo-2.0-generate-001') {
                    parameters.durationSeconds = parseInt(durationSelectText.value, 10);
                    parameters.aspectRatio = aspectRatioSelectVeo2Text.value;
                } else {
                    parameters.aspectRatio = "16:9";
                    parameters.personGeneration = "allow_all";
                }
                return { 
                    id: `prompt-result-${i}`,
                    payload: { instances: [{ prompt: p }], parameters: parameters },
                    originalPrompt: p,
                    modelName: modelName,
                    isVideo: true
                };
            });
            
            const batchSize = parseInt(multipleGenerateSelect.value, 10);
            runBatchProcessing(tasks, batchSize, async (task) => {
                const result = await processGeneration(task);
                if (result) {
                    const mediaUrl = URL.createObjectURL(result.mediaBlob);
                    generatedMedia.push({ id: task.id, url: mediaUrl, name: task.originalPrompt, type: 'video' });
                    updateResult(task.id, task.originalPrompt, 'Selesai', 'Video berhasil dibuat!', mediaUrl, 'video');
                }
                return result;
            }, generateBtnText, promptsInput);
        });

        imageForm.addEventListener('submit', async (event) => {
            event.preventDefault(); 
            const modelName = modelSelectVideoImage.value;
            const imageBlocks = imageUploadsContainer.querySelectorAll('[id^="image-block-"]');
            if (imageBlocks.length === 0) { alert('Mohon unggah setidaknya satu gambar.'); return; }
            
            resultsContainer.innerHTML = ''; 
            const tasks = Array.from(imageBlocks).map((block, i) => ({ block, id: `prompt-result-img-${i}` }));

            const batchSize = parseInt(multipleGenerateSelect.value, 10);
            runBatchProcessing(tasks, batchSize, async (task) => {
                return new Promise((resolve) => {
                    const fileInput = task.block.querySelector('input[type="file"]'); 
                    const promptTextarea = task.block.querySelector('textarea');
                    let file = fileInput.files[0]; 
                    let promptText = promptTextarea.value.trim();

                    if (!file) { 
                        updateResult(task.id, "Input Tidak Lengkap", "Error", `Gambar untuk item ini belum diisi.`); 
                        resolve(null); 
                        return; 
                    }

                    const processImage = (base64Data, finalPrompt) => {
                        const parameters = { sampleCount: 1, negativePrompt: negativePromptInput.value.trim() || undefined };
                        if (modelName === 'veo-2.0-generate-001') {
                            parameters.durationSeconds = parseInt(durationSelectImage.value, 10);
                            parameters.aspectRatio = aspectRatioSelectVeo2Image.value;
                        } else {
                            parameters.aspectRatio = "16:9";
                            parameters.personGeneration = "allow_adult";
                        }
                        const payload = { instances: [{ prompt: finalPrompt, image: { "bytesBase64Encoded": base64Data, "mimeType": file.type } }], parameters: parameters };
                        
                        const taskDetails = {
                            id: task.id,
                            payload: payload,
                            originalPrompt: finalPrompt || `Gambar: ${file.name}`,
                            modelName: modelName,
                            isVideo: true
                        };
                        
                        processGeneration(taskDetails).then(result => {
                            if (result) {
                                const mediaUrl = URL.createObjectURL(result.mediaBlob);
                                generatedMedia.push({ id: task.id, url: mediaUrl, name: `Image_${file.name}_${finalPrompt}`, type: 'video' });
                                updateResult(task.id, taskDetails.originalPrompt, 'Selesai', 'Video berhasil dibuat!', mediaUrl, 'video');
                            }
                            resolve(result);
                        });
                    };

                    const reader = new FileReader();
                    reader.onload = (e) => processImage(e.target.result.split(',')[1], promptText);
                    reader.readAsDataURL(file);
                });
            }, generateBtnImage);
        });

        textToImageForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const modelName = modelSelectImage.value;
            const prompts = imagePromptsInput.value.trim().split('\n').filter(p => p.trim() !== '');
            if (prompts.length === 0) { alert('Mohon isi setidaknya satu prompt.'); return; }
            resultsContainer.innerHTML = '';
            
            const tasks = prompts.map((p, i) => {
                const parameters = { sampleCount: 1, aspectRatio: aspectRatioSelectImageGen.value, negativePrompt: negativePromptInput.value.trim() || undefined };
                return {
                    id: `image-result-${i}`,
                    payload: { instances: [{ prompt: p }], parameters },
                    originalPrompt: p,
                    modelName: modelName,
                    isVideo: false
                };
            });
            
            const batchSize = parseInt(multipleGenerateSelect.value, 10);
            runBatchProcessing(tasks, batchSize, async (task) => {
                const result = await processGeneration(task);
                if (result) {
                    const mediaUrl = URL.createObjectURL(result.mediaBlob);
                    generatedMedia.push({ id: task.id, url: mediaUrl, name: task.originalPrompt, type: 'image' });
                    updateResult(task.id, task.originalPrompt, 'Selesai', 'Gambar berhasil dibuat!', mediaUrl, 'image');
                }
                return result;
            }, generateBtnTextToImage, imagePromptsInput);
        });

        jsonForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            resultsContainer.innerHTML = '';
            generateBtnJson.disabled = true;
            
            try {
                const modelName = modelSelectVideoJson.value;
                const promptText = jsonPromptInput.value.trim();
                if (!promptText) { throw new Error("JSON Prompt tidak boleh kosong."); }

                const parameters = { sampleCount: 1, negativePrompt: negativePromptInput.value.trim() || undefined };
                 if (modelName === 'veo-2.0-generate-001') {
                    parameters.durationSeconds = parseInt(durationSelectJson.value, 10);
                    parameters.aspectRatio = aspectRatioSelectVeo2Json.value;
                } else {
                    parameters.aspectRatio = "16:9";
                    parameters.personGeneration = "allow_all";
                }

                const taskDetails = {
                    id: 'json-result-1',
                    payload: { instances: [{ prompt: promptText }], parameters: parameters },
                    originalPrompt: promptText,
                    modelName: modelName,
                    isVideo: true
                };
                
                const result = await processGeneration(taskDetails);
                if (result) {
                    const mediaUrl = URL.createObjectURL(result.mediaBlob);
                    updateResult('json-result-1', promptText, 'Selesai', 'Video berhasil dibuat!', mediaUrl, 'video');
                }
            } catch (error) {
                 showErrorModal(`Error: ${error.message}`);
            } finally {
                generateBtnJson.disabled = false;
            }
        });

        imageToImageForm.addEventListener('submit', (event) => {
            event.preventDefault();
            resultsContainer.innerHTML = '';
            const file = i2iUploadInput.files[0];
            const prompt = i2iPrompt.value.trim();
            if (!file || !prompt) {
                showErrorModal("Mohon unggah gambar referensi dan isi prompt.");
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const base64Data = e.target.result.split(',')[1];
                const mimeType = file.type;
                const tasks = [];
                const numSamples = parseInt(i2iSampleCount.value, 10);
                
                for (let i = 0; i < numSamples; i++) {
                    tasks.push({
                        id: `i2i-result-${i}`,
                        payload: {
                           contents: [{
                                parts: [
                                    { text: prompt },
                                    { inlineData: { mimeType: mimeType, data: base64Data } }
                                ]
                            }],
                            generationConfig: { 
                                responseModalities: ['IMAGE'],
                                // Aspect ratio for gemini is handled by the prompt, not a parameter
                            }
                        },
                        originalPrompt: `${prompt} (Hasil #${i + 1})`,
                        modelName: 'gemini-2.5-flash-image-preview',
                        apiMethod: 'generateContent',
                        isVideo: false
                    });
                }

                runBatchProcessing(tasks, 1, async (task) => {
                     const result = await processGeneration(task);
                     if (result) {
                         const mediaUrl = URL.createObjectURL(result.mediaBlob);
                         generatedMedia.push({ id: task.id, url: mediaUrl, name: task.originalPrompt, type: 'image' });
                         updateResult(task.id, task.originalPrompt, 'Selesai', 'Gambar berhasil dibuat!', mediaUrl, 'image');
                     }
                     return result;
                }, generateBtnI2I);
            };
            reader.readAsDataURL(file);
        });

        i2iUploadInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    i2iPreview.style.backgroundImage = `url('${e.target.result}')`;
                    i2iPreview.innerHTML = '';
                };
                reader.readAsDataURL(file);
            }
        });

        // --- Iklan Generator Logic ---
        iklanBatchUploadInput.addEventListener('change', (event) => {
            const files = event.target.files;
            if (!files || files.length === 0) return;
            
            uploadedIklanFiles = Array.from(files);
            iklanPreviewContainer.innerHTML = '';

            uploadedIklanFiles.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const previewWrapper = document.createElement('div');
                    previewWrapper.className = 'relative aspect-square';
                    previewWrapper.innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover rounded-lg shadow-md">`;
                    iklanPreviewContainer.appendChild(previewWrapper);
                }
                reader.readAsDataURL(file);
            });
        });

        iklanGeneratorForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            if (uploadedIklanFiles.length === 0) {
                showErrorModal("Mohon unggah setidaknya satu gambar produk.");
                return;
            }
            apiKeyManager.init(apiKeyInput.value);
            if (!apiKeyManager.hasKeys()) {
                showErrorModal("Mohon masukkan API Key Anda.");
                return;
            }
            
            generateIklanBtn.disabled = true;
            generateIklanBtn.querySelector('.btn-text').textContent = 'Membuat Aset...';
            iklanResultsContainer.innerHTML = '';
            resultsContainer.innerHTML = ''; // Clear main results too
            let allSceneData = []; // To store {prompt, imageUrl} for voiceover

            // 1. Generate image variations for all uploaded product images
            const imageGenerationPromises = uploadedIklanFiles.map((file, i) => {
                const sceneId = `iklan-scene-${i}`;
                const sceneContainer = document.createElement('div');
                sceneContainer.id = sceneId;
                sceneContainer.className = 'bg-black/20 p-4 rounded-lg mb-6';
                sceneContainer.innerHTML = `<h3 class="text-lg font-semibold text-white mb-4">Adegan untuk: ${file.name}</h3><div class="grid grid-cols-2 md:grid-cols-3 gap-4 image-variations-grid"></div>`;
                iklanResultsContainer.appendChild(sceneContainer);
                
                return generateScenePromptsForProduct(file).then(scenePromptsText => {
                    const scenePrompts = scenePromptsText.split('\n').filter(p => p.trim() !== '');
                    const variationsGrid = sceneContainer.querySelector('.image-variations-grid');
                    const variationPromises = scenePrompts.map((prompt, index) => 
                        generateImageVariation(file, prompt, `${sceneId}-img-${index}`, variationsGrid)
                        .then(result => {
                            if(result) allSceneData.push(result);
                        })
                    );
                    return Promise.all(variationPromises);
                }).catch(error => {
                    sceneContainer.innerHTML += `<p class="text-red-400">Gagal membuat adegan: ${error.message}</p>`;
                });
            });
            
            await Promise.all(imageGenerationPromises);
             
            // 2. Generate Voice Over script after all images are done
            if (allSceneData.length > 0) {
                const sceneDescriptions = allSceneData.map(d => d.prompt);
                await generateVoiceOverScript(sceneDescriptions);
            }

            generateIklanBtn.disabled = false;
            generateIklanBtn.querySelector('.btn-text').textContent = 'Buat Aset Iklan';
        });

        async function generateScenePromptsForProduct(file) {
            const deskripsi = iklanDeskripsi.value.trim();
            const vibe = document.querySelector('input[name="iklan_vibe"]:checked').value;
            const lighting = document.querySelector('input[name="iklan_lighting"]:checked').value;
            const contentType = document.querySelector('input[name="iklan_content"]:checked').value;

            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const base64Data = e.target.result.split(',')[1];
                    const mimeType = file.type;
                    const prompt = `
You are a world-class creative director for a top-tier advertising agency.
Analyze the product in this image. Product Description: "${deskripsi || 'Not provided'}".
Your task is to generate exactly 5 distinct, creative, and professional scene descriptions (image prompts) for a high-energy ad campaign, specifically designed for a **vertical 9:16 aspect ratio video**.

Strictly adhere to this creative direction:
- **Vibe:** ${vibe}
- **Lighting:** ${lighting}
- **Content Type:** ${contentType}

The prompts must be diverse, covering different angles and concepts (e.g., lifestyle, studio, action, detail shots) suitable for a vertical format.
Respond ONLY with the 5 prompts. Each prompt must be on a new line. The prompts must be in English. Do not add any introductory or concluding text.
`;
                    const payload = { contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType, data: base64Data } }] }] };
                    try {
                        const result = await callGeminiApi(payload, apiKeyManager.getKey());
                        resolve(result);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = (error) => reject(error);
                reader.readAsDataURL(file);
            });
        }

        async function generateImageVariation(originalFile, prompt, imageId, gridContainer) {
             return new Promise((resolve) => {
                const placeholder = document.createElement('div');
                placeholder.id = imageId;
                placeholder.className = 'aspect-square bg-black/30 rounded-lg flex flex-col items-center justify-center text-center p-2';
                placeholder.innerHTML = `<div class="loader"></div><p class="text-xs mt-2 text-gray-400">${prompt.substring(0, 40)}...</p>`;
                gridContainer.appendChild(placeholder);

                const reader = new FileReader();
                reader.onload = async (e) => {
                    const base64Data = e.target.result.split(',')[1];
                    const mimeType = originalFile.type;
                    const apiKey = apiKeyManager.getKey();

                    if (!apiKey) {
                        placeholder.innerHTML = `<div class="p-2 text-center text-red-400 text-xs">Gagal: API Key tidak ada.</div>`;
                        resolve(null);
                        return;
                    }

                    const payload = {
                        contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType, data: base64Data } }] }],
                        generationConfig: { responseModalities: ['IMAGE'] }
                    };
                    
                    try {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`, {
                            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                        });

                        if (!response.ok) throw new Error((await response.json()).error.message);
                        
                        const result = await response.json();
                        const imageData = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
                        if (!imageData) throw new Error('No image data in response from Gemini.');

                        const imageUrl = `data:image/png;base64,${imageData}`;
                        const imageCard = document.getElementById(imageId);
                        imageCard.innerHTML = `
                            <div class="relative w-full h-full group bg-black rounded-lg">
                                <img src="${imageUrl}" class="w-full h-full object-cover rounded-lg transition-transform duration-300 group-hover:scale-105">
                                <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-2 rounded-b-lg">
                                    <div class="flex gap-2 justify-center">
                                         <button class="preview-btn text-xs bg-gray-500/50 hover:bg-gray-500 text-white font-semibold py-1 px-2 rounded-md" data-url="${imageUrl}" data-type="image">Preview</button>
                                         <a href="${imageUrl}" download="${prompt.substring(0,20)}.png" class="download-btn text-xs bg-blue-500/70 hover:bg-blue-600 text-white font-semibold py-1 px-2 rounded-md">Download</a>
                                    </div>
                                    <button class="generate-iklan-video-btn w-full mt-2 bg-teal-500 text-white font-bold py-1 px-2 rounded-lg hover:bg-teal-600 text-xs" data-image-url="${imageUrl}" data-prompt="${prompt}">
                                        Buat Video
                                    </button>
                                </div>
                            </div>
                        `;
                        resolve({ prompt: prompt, imageUrl: imageUrl });
                    } catch(error) {
                         const imageCard = document.getElementById(imageId);
                         imageCard.innerHTML = `<div class="p-2 text-center text-red-400 text-xs">Gagal: ${error.message}</div>`;
                         resolve(null);
                    }
                };
                reader.readAsDataURL(originalFile);
            });
        }
        
        async function generateVoiceOverScript(scenePrompts) {
            const deskripsi = iklanDeskripsi.value.trim();
            const vibe = document.querySelector('input[name="iklan_vibe"]:checked').value;
            const contentType = document.querySelector('input[name="iklan_content"]:checked').value;

            const prompt = `
You are a professional copywriter for commercials.
Based on a product with the description "${deskripsi || 'No description provided'}" and the following video scenes, write a compelling, concise, and professional voice-over script for a 30-second video ad.
The script must be engaging, persuasive, and perfectly match the creative direction.

- **Creative Vibe:** ${vibe}
- **Content Type:** ${contentType}

Format the output clearly with timing cues. Example: (0-5s), (5-10s), etc.
The language of the script must be Indonesian.

Video Scenes to describe:
- ${scenePrompts.join('\n- ')}
            `;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            const scriptContainer = document.createElement('div');
            scriptContainer.className = "mt-10";
            scriptContainer.innerHTML = `
                <h3 class="text-xl font-semibold text-white mb-4">Naskah Voice Over (VO)</h3>
                <div id="vo-placeholder" class="bg-black/30 p-4 rounded-lg text-center text-gray-300">Menulis naskah...</div>
            `;
            iklanResultsContainer.appendChild(scriptContainer);
            try {
                const result = await callGeminiApi(payload, apiKeyManager.getKey());
                document.getElementById('vo-placeholder').innerHTML = `<pre class="whitespace-pre-wrap font-sans text-left">${result}</pre>`;
            } catch (error) {
                document.getElementById('vo-placeholder').textContent = `Gagal membuat naskah: ${error.message}`;
            }
        }

        iklanResultsContainer.addEventListener('click', async (event) => {
            const button = event.target.closest('button');
            if (!button) return;

            if (button.classList.contains('preview-btn')) {
                openPreviewModal(button.dataset.url, button.dataset.type);
            }

            if (button.classList.contains('generate-iklan-video-btn')) {
                const imageUrl = button.dataset.imageUrl;
                const prompt = button.dataset.prompt;
                const imageCard = button.closest('.relative');

                button.disabled = true;
                button.innerHTML = `<div class="loader mx-auto"></div>`;

                try {
                    const response = await fetch(imageUrl);
                    const blob = await response.blob();
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        const taskId = `video-${Date.now()}`;
                        try {
                            const base64Data = e.target.result.split(',')[1];
                            const mimeType = blob.type;
                            
                            const tempResultCard = document.createElement('div');
                            tempResultCard.id = taskId;
                            resultsContainer.appendChild(tempResultCard); // Hidden, just for logic
                            
                            const task = {
                                id: taskId,
                                payload: {
                                    instances: [{ 
                                        prompt: prompt,
                                        image: { "bytesBase64Encoded": base64Data, "mimeType": mimeType }
                                    }],
                                    parameters: { 
                                        sampleCount: 1, 
                                        aspectRatio: "9:16",
                                        durationSeconds: 8,
                                        personGeneration: "allow_adult"
                                    }
                                },
                                originalPrompt: prompt,
                                modelName: 'veo-2.0-generate-001',
                                isVideo: true
                            };
                            
                            const videoResult = await processGeneration(task);
                            if (!videoResult) return; // Error is already handled inside processGeneration
                            
                            tempResultCard.remove();
                            const videoUrl = URL.createObjectURL(videoResult.mediaBlob);
                            const videoContainer = document.createElement('div');
                            videoContainer.className = "relative w-full h-full";
                            videoContainer.innerHTML = `
                                <video controls autoplay loop class="w-full h-full object-cover rounded-lg"><source src="${videoUrl}" type="video/mp4"></video>
                                <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-2 rounded-b-lg">
                                    <div class="flex gap-2 justify-center">
                                        <button class="preview-btn text-xs bg-gray-500/50 hover:bg-gray-500 text-white font-semibold py-1 px-2 rounded-md" data-url="${videoUrl}" data-type="video">Preview</button>
                                        <a href="${videoUrl}" download="${prompt.substring(0,20)}.mp4" class="download-btn text-xs bg-blue-500/70 hover:bg-blue-600 text-white font-semibold py-1 px-2 rounded-md">Download</a>
                                    </div>
                                </div>`;
                            imageCard.innerHTML = '';
                            imageCard.appendChild(videoContainer);

                        } catch (generationError) {
                            const tempResultCard = document.getElementById(taskId);
                            if (tempResultCard) {
                                 const parentGridCell = imageCard.parentElement;
                                 if (parentGridCell) {
                                    parentGridCell.innerHTML = `<div class="p-2 text-center text-red-400 text-xs flex items-center justify-center h-full">${generationError.message}</div>`;
                                 }
                                 tempResultCard.remove();
                            } else {
                                imageCard.innerHTML = `<div class="p-2 text-center text-red-400 text-xs">Gagal membuat video.</div>`;
                            }
                            button.disabled = false;
                            button.textContent = "Buat Video";
                        }
                    };
                    reader.readAsDataURL(blob);
                } catch (error) {
                    button.disabled = false;
                    button.textContent = "Buat Video";
                    showErrorModal(`Gagal memproses gambar untuk video: ${error.message}`);
                }
            }
        });

        cancelBtn.addEventListener('click', () => {
            stopAllProcessing = true;
            showErrorModal("Semua proses yang sedang berjalan akan dibatalkan.");
        });

        downloadAllZipBtn.addEventListener('click', async () => {
            const zip = new JSZip();
            if (generatedMedia.length === 0) { alert("Tidak ada media yang berhasil dibuat untuk diunduh."); return; }
            downloadAllZipBtn.disabled = true;
            downloadAllZipBtn.textContent = 'Menyiapkan file zip...';
            try {
                for (let i = 0; i < generatedMedia.length; i++) {
                    const media = generatedMedia[i];
                    const response = await fetch(media.url);
                    const blob = await response.blob();
                    const extension = media.type === 'video' ? 'mp4' : 'png';
                    const fileName = `${media.name.substring(0, 30).replace(/[^a-z0-9]/gi, '_')}_${i}.${extension}`;
                    zip.file(fileName, blob);
                }
                zip.generateAsync({ type: "blob" }).then(function(content) {
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(content);
                    link.download = "veo_generated_media.zip";
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                });
            } catch (error) {
                showErrorModal(`Gagal membuat file zip: ${error.message}`);
            } finally {
                downloadAllZipBtn.disabled = false;
                downloadAllZipBtn.textContent = 'Download Semua sebagai .zip';
            }
        });

        downloadAllFilesBtn.addEventListener('click', async () => {
             const activePanel = document.querySelector('#app-container div[id^="panel-"]:not(.hidden)');
             const isImagePanel = activePanel.id === 'panel-text-to-image' || activePanel.id === 'panel-image-to-image';
             const mediaToDownload = isImagePanel ? generatedMedia.filter(m => m.type === 'image') : generatedMedia.filter(m => m.type === 'video');
            if (mediaToDownload.length === 0) { alert(`Tidak ada ${isImagePanel ? 'gambar' : 'video'} yang berhasil dibuat untuk diunduh.`); return; }
            downloadAllFilesBtn.disabled = true;
            downloadAllFilesBtn.textContent = 'Memulai unduhan...';
            for (let i = 0; i < mediaToDownload.length; i++) {
                const media = mediaToDownload[i];
                const link = document.createElement('a');
                link.href = media.url;
                const extension = media.type === 'video' ? 'mp4' : 'png';
                const fileName = `${media.name.substring(0, 30).replace(/[^a-z0-9]/gi, '_')}_${i}.${extension}`;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                await sleep(500);
            }
            downloadAllFilesBtn.disabled = false;
            downloadAllFilesBtn.textContent = `Download Semua File`;
        });
        
        function handleVeo2SettingsVisibility(selectElement, containerElement) {
             if (selectElement.value === 'veo-2.0-generate-001') {
                containerElement.classList.remove('hidden');
            } else {
                containerElement.classList.add('hidden');
            }
        }
        
        modelSelectVideoText.addEventListener('change', () => handleVeo2SettingsVisibility(modelSelectVideoText, veo2SettingsContainerText));
        modelSelectVideoImage.addEventListener('change', () => handleVeo2SettingsVisibility(modelSelectVideoImage, veo2SettingsContainerImage));
        modelSelectVideoJson.addEventListener('change', () => handleVeo2SettingsVisibility(modelSelectVideoJson, veo2SettingsContainerJson));
        
        function updatePromptCount(textarea, countElement) {
            if (!textarea || !countElement) return;
            const count = textarea.value.trim() === '' ? 0 : textarea.value.trim().split('\n').filter(line => line.trim() !== '').length;
            countElement.textContent = count;
        }

        promptsInput.addEventListener('input', () => updatePromptCount(promptsInput, promptCountText));
        imagePromptsInput.addEventListener('input', () => updatePromptCount(imagePromptsInput, promptCountImage));

        resultsContainer.addEventListener('click', (event) => {
            const target = event.target;
            if (target.classList.contains('delete-result-btn')) {
                const promptId = target.dataset.promptId;
                const cardToDelete = document.getElementById(promptId);
                if (cardToDelete) { cardToDelete.remove(); }
                generatedMedia = generatedMedia.filter(media => media.id !== promptId);
                delete tasksStore[promptId];
                if (generatedMedia.length === 0) {
                    downloadAllContainer.classList.add('hidden');
                }
                if (!document.querySelector('.retry-btn')) {
                    postProcessingActionsContainer.classList.add('hidden');
                }
            }
            if (target.classList.contains('retry-btn')) {
                const promptId = target.dataset.promptId;
                const taskToRetry = tasksStore[promptId];
                if (taskToRetry) {
                    const activeTextarea = document.querySelector('#panel-text-to-video:not(.hidden) textarea, #panel-text-to-image:not(.hidden) textarea');
                    processGeneration(taskToRetry).then(result => {
                         if (result) {
                            const mediaUrl = URL.createObjectURL(result.mediaBlob);
                            generatedMedia.push({ id: taskToRetry.id, url: mediaUrl, name: taskToRetry.originalPrompt, type: result.mediaType });
                            updateResult(taskToRetry.id, taskToRetry.originalPrompt, 'Selesai', 'Media berhasil dibuat!', mediaUrl, result.mediaType);
                            if(activeTextarea) {
                                removePromptFromTextarea(taskToRetry.originalPrompt, activeTextarea);
                            }
                            if (!document.querySelector('.retry-btn')) {
                                postProcessingActionsContainer.classList.add('hidden');
                            }
                            if (generatedMedia.length > 0) {
                                downloadAllContainer.classList.remove('hidden');
                            }
                        }
                    });
                }
            }
        });

        retryAllBtn.addEventListener('click', () => {
            const errorCards = document.querySelectorAll('.retry-btn');
            if (errorCards.length === 0) {
                showErrorModal("Tidak ada proses yang gagal untuk dicoba ulang.");
                return;
            }
            errorCards.forEach(btn => btn.click());
        });

        // --- Review Produk UI Logic ---
        function setupAssetUpload(inputId, labelId, previewId, textId, removeBtnId, fileStoreSetter) {
            const input = document.getElementById(inputId);
            const label = document.getElementById(labelId);
            const preview = document.getElementById(previewId);
            const text = document.getElementById(textId);
            const removeBtn = document.getElementById(removeBtnId);

            label.addEventListener('click', (e) => { if(!e.target.matches('.remove-asset-btn')) input.click() });
            
            input.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    fileStoreSetter(file);
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        preview.src = e.target.result;
                        preview.classList.remove('hidden');
                        text.classList.add('hidden');
                        removeBtn.classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            removeBtn.addEventListener('click', (e) => {
                e.preventDefault(); // Prevent label click
                input.value = '';
                fileStoreSetter(null);
                preview.src = '';
                preview.classList.add('hidden');
                text.classList.remove('hidden');
                removeBtn.classList.add('hidden');
            });
        }
        
        setupAssetUpload('review-produk-upload', 'review-produk-label', 'review-produk-preview', 'review-produk-text', 'remove-produk-btn', file => uploadedReviewProductFile = file);
        setupAssetUpload('review-wajah-upload', 'review-wajah-label', 'review-wajah-preview', 'review-wajah-text', 'remove-wajah-btn', file => uploadedReviewWajahFile = file);
        
        function populateVibeOptions() {
            const vibes = [
                { emoji: '☕', name: 'Kafe Estetik' }, { emoji: '🌃', name: 'Gaya Urban (Malam)' },
                { emoji: '🌴', name: 'Pantai Tropis' }, { emoji: '🏢', name: 'Apartemen Mewah' },
                { emoji: '🌸', name: 'Taman Bunga' }, { emoji: '🏛️', name: 'Gedung Tua' },
                { emoji: '📚', name: 'Perpustakaan Klasik' }, { emoji: '🎨', name: 'Studio Minimalis' },
                { emoji: '🍸', name: 'Rooftop Bar' }, { emoji: '🍂', name: 'Taman Musim Gugur' },
                { emoji: '🏮', name: 'Jalanan Tokyo' }, { emoji: '🛋️', name: 'Interior Skandinavia' },
                { emoji: '🌲', name: 'Hutan Ajaib' }, { emoji: '🤖', name: 'Kota Cyberpunk' },
                { emoji: '🌵', name: 'Gurun Bohemian' }, { emoji: '🖼️', name: 'Galeri Seni Modern' },
                { emoji: '🌇', name: 'Rooftop Senja' }, { emoji: '❄️', name: 'Kabin Gunung Salju' },
                { emoji: '🏭', name: 'Loteng Industrial' }, { emoji: '🔬', name: 'Laboratorium Futuristik' },
                { emoji: '☁️', name: 'Alam Mimpi Pastel' }, { emoji: '👑', name: 'Interior Istana' },
                { emoji: '🍳', name: 'Dapur Pedesaan' }, { emoji: '🐠', name: 'Terumbu Karang' },
                { emoji: '🥐', name: 'Jalanan Paris' }, { emoji: '🍜', name: 'Pasar Malam Asia' },
                { emoji: '🛳️', name: 'Dek Kapal Pesiar' }, { emoji: '🚂', name: 'Stasiun Kereta Vintage' },
                { emoji: '🏀', name: 'Lapangan Basket Outdoor' }, { emoji: '🧑‍🍳', name: 'Dapur Profesional' },
                { emoji: '✨', name: 'Lobi Hotel Mewah' }, { emoji: '🎸', name: 'Panggung Konser Rock' },
                { emoji: '⛩️', name: 'Taman Zen Jepang' }, { emoji: '🍇', name: 'Teras Vila Mediterania' },
                { emoji: '🚀', name: 'Ruang Angkasa' }, { emoji: '💻', name: 'Ruang Kerja Modern' },
                { emoji: '♨️', name: 'Pemandian Air Panas' }, { emoji: '🏰', name: 'Ruang Tahta Fantasi' },
                { emoji: '🏙️', name: 'Puncak Pencakar Langit' }, { emoji: '🏎️', name: 'Garasi Mobil Sport' },
                { emoji: '🌿', name: 'Rumah Kaca Botani' }, { emoji: '⛸️', name: 'Gelanggang Es' },
                { emoji: '💃', name: 'Ruang Dansa Klasik' }, { emoji: '🔥', name: 'Pesta Pantai (Malam)' },
                { emoji: '📜', name: 'Perpustakaan Kuno' }, { emoji: '🏞️', name: 'Dek Observasi Gunung' },
                { emoji: '🕺', name: 'Studio Tari Modern' }, { emoji: '🤫', name: 'Bar Speakeasy' },
                { emoji: '🦜', name: 'Jalur Hutan Hujan' }, { emoji: '🌾', name: 'Sawah Terasering' }
            ];

            vibes.forEach((vibe, index) => {
                const vibeId = `vibe_${index}`;
                const isChecked = index === 0 ? 'checked' : '';
                const optionHTML = `
                    <div class="creative-option">
                        <input type="radio" name="review_vibe" id="${vibeId}" value="${vibe.name}" class="sr-only" ${isChecked}>
                        <label for="${vibeId}" class="block cursor-pointer border-2 border-gray-600 rounded-full px-4 py-2 text-sm hover:border-[var(--accent-teal)]">
                            ${vibe.emoji} ${vibe.name}
                        </label>
                    </div>`;
                reviewVibeContainer.innerHTML += optionHTML;
            });
        }
        
        reviewProdukForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!uploadedReviewProductFile || !uploadedReviewWajahFile) {
                showErrorModal("Mohon unggah gambar produk dan gambar wajah.");
                return;
            }
            apiKeyManager.init(apiKeyInput.value);
            if (!apiKeyManager.hasKeys()) {
                showErrorModal("Mohon masukkan API Key Anda.");
                return;
            }

            generateReviewBtn.disabled = true;
            generateReviewBtn.querySelector('.btn-text').textContent = 'Menganalisis...';
            reviewResultsContainer.innerHTML = `<div class="text-center"><div class="loader mx-auto"></div><p class="mt-2 text-sm text-gray-400">Membuat alur cerita dan naskah...</p></div>`;

            try {
                const deskripsi = reviewDeskripsi.value.trim();
                const vibe = document.querySelector('input[name="review_vibe"]:checked').value;

                // Step 1: Generate Storyboard Prompts
                const storyboardPromptsText = await generateReviewStoryboardPrompts(deskripsi, vibe);
                const storyboardPrompts = storyboardPromptsText.split('\n').filter(p => p.trim() !== '');

                // Step 2: Generate Full Script
                const fullScript = await generateReviewScript(deskripsi, vibe, storyboardPrompts);

                // Step 3: Display Script and prepare for storyboard images
                reviewResultsContainer.innerHTML = `
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-1">
                            <h3 class="text-xl font-semibold text-white mb-4">Naskah Lengkap</h3>
                            <div class="bg-black/30 p-4 rounded-lg text-sm whitespace-pre-wrap font-sans">${fullScript}</div>
                        </div>
                        <div class="lg:col-span-2">
                            <h3 class="text-xl font-semibold text-white mb-4">Hasil Storyboard</h3>
                            <div id="storyboard-grid" class="grid grid-cols-2 gap-4">
                                <!-- Storyboard images will be generated here -->
                            </div>
                        </div>
                    </div>
                `;

                const storyboardGrid = document.getElementById('storyboard-grid');
                
                // Step 4: Generate each storyboard image
                const imagePromises = storyboardPrompts.map((prompt, index) => 
                    generateReviewImage(prompt, `review-img-${index}`, storyboardGrid)
                );

                await Promise.all(imagePromises);

            } catch (error) {
                reviewResultsContainer.innerHTML = `<p class="text-red-400 text-center">Gagal membuat konten review: ${error.message}</p>`;
            } finally {
                generateReviewBtn.disabled = false;
                generateReviewBtn.querySelector('.btn-text').textContent = 'Generate Konten Review';
            }
        });
        
        async function generateReviewStoryboardPrompts(deskripsi, vibe) {
            const fileToB64 = (file) => new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });

            const [produkBase64, wajahBase64] = await Promise.all([
                fileToB64(uploadedReviewProductFile),
                fileToB64(uploadedReviewWajahFile)
            ]);

            const prompt = `
You are a creative director specializing in product reviews. Your task is to create a 4-scene storyboard for a product review video.

**Inputs:**
1.  **Product:** A product with the description: "${deskripsi || 'Not provided'}". (See attached product image).
2.  **Reviewer:** The person reviewing the product. (See attached face image).
3.  **Background Vibe:** The review should take place in a location with a "${vibe}" vibe.

**Task:**
Generate exactly 4 distinct, engaging scene descriptions (prompts) for the storyboard. Each prompt should describe the reviewer interacting with the product in the specified background. The scenes should follow a logical review flow: unboxing/first impression, showing a key feature, showing the product in use, and a final hero shot with a recommendation.

**Rules:**
- Each prompt must be on a new line.
- Each prompt must be in English.
- The prompts should be detailed enough for an image generation model to create a compelling visual.
- Ensure the reviewer's face from the reference image is clearly described in each scene.
- Respond ONLY with the 4 prompts. Do not add any introductory or concluding text.
            `;

            const payload = {
                contents: [{
                    parts: [
                        { text: prompt },
                        { inlineData: { mimeType: uploadedReviewProductFile.type, data: produkBase64 } },
                        { inlineData: { mimeType: uploadedReviewWajahFile.type, data: wajahBase64 } }
                    ]
                }]
            };
            return callGeminiApi(payload, apiKeyManager.getKey());
        }

        async function generateReviewScript(deskripsi, vibe, storyboardPrompts) {
            const prompt = `
You are a professional scriptwriter for product review videos.
Based on the following product information and storyboard scenes, write a complete, engaging, and persuasive script for the reviewer to say.

**Product Description:** ${deskripsi || 'No description provided'}
**Background Vibe:** ${vibe}
**Storyboard Scenes:**
- ${storyboardPrompts.join('\n- ')}

**Task:**
Write a natural-sounding, enthusiastic script in Indonesian. The script should align perfectly with the storyboard scenes, guiding the viewer from one scene to the next. Start with a hook, explain the product's benefits based on the scenes, and end with a clear call-to-action.

Respond ONLY with the complete script. Do not add any introductory or concluding text.
            `;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            return callGeminiApi(payload, apiKeyManager.getKey());
        }

        async function generateReviewImage(prompt, imageId, gridContainer) {
            const placeholder = document.createElement('div');
            placeholder.id = imageId;
            placeholder.className = 'aspect-[9/16] bg-black/30 rounded-lg flex flex-col items-center justify-center text-center p-2';
            placeholder.innerHTML = `<div class="loader"></div><p class="text-xs mt-2 text-gray-400">${prompt.substring(0, 40)}...</p>`;
            gridContainer.appendChild(placeholder);
            
            const fileToB64 = (file) => new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });

            try {
                const [produkBase64, wajahBase64] = await Promise.all([
                    fileToB64(uploadedReviewProductFile),
                    fileToB64(uploadedReviewWajahFile)
                ]);

                const apiKey = apiKeyManager.getKey();
                if (!apiKey) throw new Error("API Key tidak ada.");
                
                const generationPrompt = `**Instructions:**
                1.  **Main Subject:** Create a photorealistic image of a person reviewing a product.
                2.  **Person's Face:** The person's face MUST look exactly like the face in the first attached image (the face reference).
                3.  **Product:** The person MUST be holding or interacting with the product shown in the second attached image (the product reference).
                4.  **Scene Description:** Place them in the following scene: "${prompt}".
                5.  **Aspect Ratio:** The final image must be in a vertical 9:16 portrait aspect ratio.
                6.  **Style:** The final image should be high-quality, photorealistic, and well-lit.`;

                const payload = {
                    contents: [{
                        parts: [
                            { text: generationPrompt },
                            { inlineData: { mimeType: uploadedReviewWajahFile.type, data: wajahBase64 } }, // Face first
                            { inlineData: { mimeType: uploadedReviewProductFile.type, data: produkBase64 } } // Product second
                        ]
                    }],
                    generationConfig: { responseModalities: ['IMAGE'] }
                };

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error((await response.json()).error.message);
                const result = await response.json();
                const imageData = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
                if (!imageData) throw new Error('No image data in response from Gemini.');

                const imageUrl = `data:image/png;base64,${imageData}`;
                const imageCard = document.getElementById(imageId);
                imageCard.innerHTML = `
                    <div class="relative w-full h-full group bg-black rounded-lg">
                        <img src="${imageUrl}" class="w-full h-full object-cover rounded-lg transition-transform duration-300 group-hover:scale-105">
                        <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-2 rounded-b-lg opacity-0 group-hover:opacity-100 transition-opacity">
                            <div class="flex gap-2 justify-center">
                                <button class="preview-btn text-xs bg-gray-500/50 hover:bg-gray-500 text-white font-semibold py-1 px-2 rounded-md" data-url="${imageUrl}" data-type="image">Preview</button>
                                <a href="${imageUrl}" download="${prompt.substring(0,20)}.png" class="download-btn text-xs bg-blue-500/70 hover:bg-blue-600 text-white font-semibold py-1 px-2 rounded-md">Download</a>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                const imageCard = document.getElementById(imageId);
                imageCard.innerHTML = `<div class="p-2 text-center text-red-400 text-xs">Gagal: ${error.message}</div>`;
            }
        }

        // Initial load
        checkAuth();
        populateVibeOptions();

    </script>
	
	
</body>
<footer class="site-footer">
    © 2025 - Developed by: <span class="credit-name">Happylife Project</span>
</footer>
</html>






